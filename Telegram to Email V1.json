{
  "name": "Telegram to Email V1",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -2720,
        3408
      ],
      "id": "eda83a53-d391-4caa-9d97-cb87c49cc4cd",
      "name": "Telegram Trigger",
      "webhookId": "a2f99f2c-391e-4f54-b8f7-13829748f9e0",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "edff1973-e4e8-4740-a933-22ddafc2ff54",
              "leftValue": "={{ $json.message?.voice?.file_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2496,
        3408
      ],
      "id": "2525ca5b-feff-40d6-82ab-dba62b8b03ac",
      "name": "Has Voice? (file_id)"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').first().json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2272,
        3344
      ],
      "id": "bdf90fb6-68ce-4169-91f4-c0cba55f3e09",
      "name": "Get a file",
      "webhookId": "0b34be1c-2808-435e-a435-01b594222fe3",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "=/files/voice.ogg",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -1824,
        3344
      ],
      "id": "81aa5d9c-0a3b-4f62-af0e-98697158ff73",
      "name": "Read/Write Files from Disk"
    },
    {
      "parameters": {
        "command": "=docker exec -i n8n-n8n1-1 sh -lc \"ffmpeg -y -hide_banner -loglevel error -i /files/voice.ogg -ac 1 -ar 16000 -c:a pcm_s16le /files/voice.wav\"\n"
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -1600,
        3344
      ],
      "id": "8b918ea9-2ff0-43d6-8fc1-408e37fa9ea3",
      "name": "Execute a command",
      "credentials": {
        "sshPassword": {
          "id": "kYeNSNAxG8kXe2aK",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "fileSelector": "/files/voice.wav",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -1376,
        3344
      ],
      "id": "9e7116b1-5c42-4bee-86d1-60dd71154159",
      "name": "Read/Write Files from Disk1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepgram.com/v1/listen?model=nova-2&smart_format=true&punctuate=true",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Token ' + $env.DEEPGRAM_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "audio/wav"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1152,
        3344
      ],
      "id": "547570f6-8e7d-4791-bfdf-bd5db7f83ff1",
      "name": "Deepgram Transcribe"
    },
    {
      "parameters": {
        "command": "docker exec -i n8n-n8n1-1 sh -lc \"rm -f /files/voice.ogg /files/voice.wav\""
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -928,
        3344
      ],
      "id": "4663a5d3-015e-4fa4-a16f-a74924dadcd2",
      "name": "Cleanup voice files",
      "credentials": {
        "sshPassword": {
          "id": "kYeNSNAxG8kXe2aK",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming Telegram update (button or message)\n// Voice transcript is read straight from the Deepgram node output\n\nlet trig = {};\ntry {\n  trig = $('Telegram Trigger').first().json ?? {};\n} catch (e) {\n  trig = $json ?? {};\n}\n\n// ---------- BUTTON CLICK ----------\nif (trig.callback_query) {\n  const cb = trig.callback_query;\n  const data = (cb.data || '').trim();\n  const [actionRaw, draftIdRaw] = data.split(':');\n\n  return [{\n    json: {\n      type: 'BUTTON',\n      action: (actionRaw || '').toUpperCase(),\n      draft_id: (draftIdRaw || '').trim(),\n      chat_id: cb.message?.chat?.id,\n      from_id: cb.from?.id,\n      telegram_msg_id: cb.message?.message_id,\n      callback_query_id: cb.id\n    }\n  }];\n}\n\n// ---------- MESSAGE ----------\nconst msg = trig.message || {};\nlet text = (msg.text || msg.caption || '').trim();\n\n// If it's a voice message, pull transcript directly from Deepgram node output\nif (!text && msg.voice?.file_id) {\n  try {\n    // IMPORTANT: change 'Deepgram' to your exact Deepgram node name (case-sensitive)\n    const dg = $('Deepgram Transcribe').first().json ?? {};\n\n    // Standard Deepgram transcript path (as in your screenshot)\n    text = (dg?.results?.channels?.[0]?.alternatives?.[0]?.transcript || '').trim();\n\n    // Fallback: rebuild sentence from (punctuated_)word list if transcript is empty\n    if (!text) {\n      const words = dg?.results?.channels?.[0]?.alternatives?.[0]?.words || [];\n      text = words\n        .map(w => (w?.punctuated_word || w?.word || '').trim())\n        .filter(Boolean)\n        .join(' ')\n        .trim();\n    }\n  } catch (e) {\n    text = '';\n  }\n}\n\nreturn [{\n  json: {\n    type: 'MESSAGE',\n    chat_id: msg.chat?.id,\n    from_id: msg.from?.id,\n    message_id: msg.message_id,\n    replied_to_message_id: msg.reply_to_message?.message_id,\n    text,\n    has_voice: !!msg.voice?.file_id,\n    voice_file_id: msg.voice?.file_id || null\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        3392
      ],
      "id": "ce198dab-6067-47ae-91d5-805db71b00cf",
      "name": "Parse Input"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "BUTTON",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f00886d1-fc52-4f5b-85d2-b20ecd611112"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "MESSAGE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f594f5b0-9f43-4e63-a65c-bfa3ed200937"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -208,
        3392
      ],
      "id": "47093d6a-286b-4d63-9c81-e404a3ad6290",
      "name": "Route by Type"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 473762709
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "pending_draft_id": "={{ String($('Parse Input').first().json.draft_id ?? '') }}",
            "mode": "waiting_edit",
            "expires_at": "={{ new Date(Date.now() + 5*60*1000).toISOString() }}",
            "field": "body"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1376,
        1584
      ],
      "id": "16e6e33c-528b-405d-8a69-32aba405547b",
      "name": "Create Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all().map(i => i.json || {});\nif (!rows.length) return [{ json: {} }];\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst filtered = rows.filter(r => String(r.chat_id||'') === chatId);\nconst list = filtered.length ? filtered : rows;\nconst sorted = list.map(r => ({ r, t: Date.parse(r.expires_at || '') })).sort((a,b)=> (a.t||0)-(b.t||0));\nreturn [{ json: sorted[sorted.length - 1].r }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        1584
      ],
      "id": "b91d07dc-5133-4ec9-ae02-f32c673a7de5",
      "name": "Pick Latest Edit Session"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice)."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1152,
        1584
      ],
      "id": "be639a38-83ad-4c3d-a938-0d21e5fdc84a",
      "name": "Answer Callback (Edit)",
      "webhookId": "40eca8ee-8613-4575-9689-c6dd1d4b0125",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 473762709
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        592,
        5504
      ],
      "id": "c1076728-1a79-4597-a2d3-2897cbcf4f64",
      "name": "Check Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "1c226fd0-ebe8-48c6-9d54-ced3096b0564"
            },
            {
              "leftValue": "={{ (() => { const mode = ($json.mode || '').toLowerCase(); return mode === 'waiting_edit'; })() }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "3dc1dd69-5c16-42c3-96cb-1ada4d1ea574"
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        976,
        5504
      ],
      "id": "45f8c6f1-1023-4f42-a468-a9a11bcd994f",
      "name": "Session Valid?"
    },
    {
      "parameters": {
        "jsCode": "// Build edit payload from session + incoming message\nconst session = $('Check Edit Session').first().json || {};\nconst incoming = $('Parse Input').first().json || {};\n\nconst instruction = (incoming.text || '').trim();\n\nreturn [{\n  json: {\n    draft_id: session.pending_draft_id,\n    edit_instruction: instruction,\n    chat_id: incoming.chat_id,\n    from_id: incoming.from_id,\n    // MESSAGE: message_id, BUTTON: telegram_msg_id\n    user_message_id: incoming.message_id || incoming.telegram_msg_id\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        5488
      ],
      "id": "fd88a785-f8d8-4e3a-ad26-c28a145ff3c7",
      "name": "Prepare Edit Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Writing preferences (follow strictly): {{ $json.prefs_text || '' }}\n\nEdit instruction: {{ $('Prepare Edit Data').first().json.edit_instruction }}\n\nCurrent draft:\n{{ $json.draft_body }}",
        "options": {
          "systemMessage": "You are an email editing assistant. Apply the user's edit instruction to the current draft.\n\nCore rules:\n- Output ONLY the revised email body\n- Apply the requested changes precisely\n- Maintain professional tone\n- Keep the greeting and signature format\n- If instruction is unclear, make your best interpretation\n\nOutput the complete revised email body, ready to send."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2976,
        5488
      ],
      "id": "d2882e5e-701c-4c62-ab66-3fc7ec3449c2",
      "name": "Apply Edits (LLM)"
    },
    {
      "parameters": {
        "chatId": "={{ $('Execute a SQL query').first().json.telegram_chat_id }}",
        "text": "={{ (() => {\n  const row = $('Execute a SQL query').first().json || {};\n\n  const rawCat = row.categoy || row.category || 'FYI';\n  const norm = String(rawCat).toUpperCase().trim().replace(/[\\s_]+/g, '_');\n  const displayCat = norm.replace(/_/g, ' ');\n\n  const from = row.from || 'Unknown';\n  const subject = row.subject || 'No subject';\n\n  let summary = '';\n  let message = '';\n  const old = row.old_email || '';\n\n  try {\n    const obj = JSON.parse(old);\n    summary = obj.summary || '';\n    message = obj.message || '';\n  } catch (e) {\n    message = old;\n  }\n\n  const redraft = $('Apply Edits (LLM)').first().json.output || '';\n\n  let out = `Category: ${displayCat}\\nFrom: ${from}\\nSubject: ${subject}\\n\\n`;\n  if (summary) out += `Summary: ${summary}\\n\\n`;\n  if (message) out += `Message:\\n${message}\\n\\n`;\n  out += `Redraft:\\n${redraft}`;\n\n  return out.trim();\n})() }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "âœ… Approve",
                    "additionalFields": {
                      "callback_data": "={{ 'approve:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  },
                  {
                    "text": "âœï¸ Edit",
                    "additionalFields": {
                      "callback_data": "={{ 'edit:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸŽ¨ Style",
                    "additionalFields": {
                      "callback_data": "style_menu"
                    }
                  },
                  {
                    "text": "ðŸ§¾ History",
                    "additionalFields": {
                      "callback_data": "={{ 'history:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5440,
        5696
      ],
      "id": "efb24e02-eca4-4c18-98d9-fbf3efe68943",
      "name": "Send Revised Draft",
      "webhookId": "cc84e9e6-8f3c-4291-8871-fcbb2f914345",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $('Execute a SQL query').first().json.gmail_message_id }}",
            "draft_body": "={{ $('Apply Edits (LLM)').first().json.output }}",
            "status": "revised",
            "telegram_msg_id": "={{ $json.result.message_id }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5872,
        5696
      ],
      "id": "de3473ac-1283-4fc6-88dc-f23d4ade2e8f",
      "name": "Update Draft in DB",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const all = $input.all().map(i => i.json || {});\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = all.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nif (!rows.length) {\n  return [{ json: { valid: false, reason: 'NO_SESSION' } }];\n}\nconst withExp = rows.map(r => ({ r, t: Date.parse(r.expires_at || '') })).sort((a,b) => (a.t||0)-(b.t||0));\nconst latest = withExp[withExp.length - 1].r;\nconst now = Date.now();\nconst expiresMs = Date.parse(latest.expires_at || '');\nconst valid = Number.isFinite(expiresMs) && expiresMs > now;\nreturn [{ json: Object.assign({}, latest, { valid, reason: valid ? 'OK' : 'EXPIRED' }) }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        5504
      ],
      "id": "abc0a951-410c-4f06-8c6e-7e48c9a7da0f",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst draftId = String($('Check Edit Session').first().json.pending_draft_id || '');\nconst chatId = String($('Prepare Edit Data').first().json.chat_id || $('Parse Input').first().json.chat_id || '');\nconst userId = String($('Prepare Edit Data').first().json.from_id || $('Parse Input').first().json.from_id || '');\nconst drafts = $('Get email_drafts (edit)').all().map(i => i.json || {});\nconst row = drafts.find(r => String(r.gmail_draft_id || '') === draftId || String(r.gmail_message_id || '') === draftId) || {};\nconst prefs = $('Get prefs (edit)').all().map(i => i.json || {});\nconst modeRow = pickLatest(prefs.filter(r => r.scope === 'mode' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst mode = (modeRow && modeRow.prefs_text) ? String(modeRow.prefs_text) : 'user';\nlet prefRow = null;\nif (mode === 'chat') {\n  prefRow = pickLatest(prefs.filter(r => r.scope === 'chat' && String(r.chat_id||'') === chatId && String(r.user_id||'') === ''));\n} else {\n  prefRow = pickLatest(prefs.filter(r => r.scope === 'user' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\n}\nconst prefs_text = (prefRow && typeof prefRow.prefs_text === 'string') ? prefRow.prefs_text : '';\nreturn [{ json: Object.assign({}, row, { prefs_text }) }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        5488
      ],
      "id": "25143bd5-85a6-422b-a4d1-cea36ffc8aa8",
      "name": "Execute a SQL query"
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst id = String($('Button Action (Core)').first().json.draft_id || '');\nconst rows = $('Get email_drafts (approve)').all().map(i => i.json || {});\nconst match = pickLatest(rows.filter(r => String(r.gmail_message_id||'') === id));\nreturn [{ json: match || {} }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        1136
      ],
      "id": "f17420e0-3ca2-4d74-b1ba-578e616eb714",
      "name": "Execute a SQL query1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2224,
        5488
      ],
      "id": "800101c9-0982-4408-9895-0c648cb26b74",
      "name": "Append User Edit MsgId (body)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "9dbe4c28-21a6-4e14-8468-641b34211199",
              "leftValue": "={{ ( $('Execute a SQL query1').first().json.telegram_message_ids || '' ).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3152,
        1136
      ],
      "id": "abefb453-bdef-4a93-88b4-fbe170ca988a",
      "name": "Has Stored Edit Msg IDs?"
    },
    {
      "parameters": {
        "jsCode": "const row = $('Execute a SQL query1').first().json;\nconst chatId = $('Parse Input').first().json.chat_id;\n\n// accept multiple possible DB column names and types\nconst stored = row.telegram_message_ids ?? row.telegram_msg_ids ?? row.telegram_msg_id ?? '';\n\nlet parts = [];\nif (Array.isArray(stored)) {\n  parts = stored.map(String);\n} else if (typeof stored === 'string') {\n  parts = stored.split(',').map(s => s.trim()).filter(Boolean);\n} else if (stored != null) {\n  parts = [String(stored)];\n}\n\nconst extra = [\n  row.telegram_msg_id,\n  $('Parse Input').first().json.message_id, // clicked approve message id\n];\n\nfor (const e of extra) {\n  if (e != null && String(e).trim() !== '') parts.push(String(e));\n}\n\nconst seen = new Set();\nreturn parts\n  .map(x => String(x).replace(/[^0-9]/g, ''))\n  .filter(x => x && !seen.has(x) && (seen.add(x), true))\n  .map(x => ({ json: { chat_id: chatId, message_id: Number(x) } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3376,
        1136
      ],
      "id": "d626b3db-b0ad-405c-a587-d6638bdce27b",
      "name": "Split Stored Edit Msg IDs"
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3664,
        1136
      ],
      "id": "c541526e-7a8a-4be3-b417-7cec2e088e06",
      "name": "Delete Stored User Edit Message",
      "webhookId": "2c6bd583-8502-41c0-aab0-dbe9f6dfee27",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ String($('Execute a SQL query1').first().json.gmail_message_id || '') }}",
            "telegram_message_ids": ""
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4176,
        1136
      ],
      "id": "91cd221e-70ea-4cc1-8cff-8cff051fe208",
      "name": "Clear Stored Edit Msg IDs",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so the next steps run once\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        1136
      ],
      "id": "034b800a-1350-4ec5-86eb-3f8b2c31aa90",
      "name": "Collapse After Deletes"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6544,
        5696
      ],
      "id": "6d033bf3-2ab5-4441-acc5-5962bd7fc20e",
      "name": "Append Bot Draft MsgId (body)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 473762709
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "mode": "Consumed",
            "expires_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1808,
        1136
      ],
      "id": "adcb9e85-dcae-4bf0-8dc5-caba2117711e",
      "name": "Consume Session (Reply)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so downstream actions run once.\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2032,
        1136
      ],
      "id": "47ac84c3-810a-4d99-9e5a-bf15da8682e4",
      "name": "Collapse After Consume (Reply)"
    },
    {
      "parameters": {
        "resource": "thread",
        "operation": "reply",
        "threadId": "={{ $('Execute a SQL query1').first().json.thread_id }}",
        "messageId": "={{ $('Execute a SQL query1').first().json.gmail_message_id }}",
        "message": "={{ $('Execute a SQL query1').first().json.draft_body }}",
        "options": {
          "replyToSenderOnly": true
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        2704,
        1136
      ],
      "id": "2992e58a-967e-473f-9c3e-a21a28250c39",
      "name": "Reply Email",
      "webhookId": "61094943-b676-495d-8a3d-5d07d9f79126",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "Loading history..."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1120,
        2064
      ],
      "id": "9cbf0929-4c85-470b-93e0-9e8f485d7a46",
      "name": "Answer Callback (History)",
      "webhookId": "ea798b3e-c01a-4444-87be-2cda75ef2cdf",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst id = String($('Button Action (Core)').first().json.draft_id || '');\nconst rows = $('Get email_drafts (history)').all().map(i => i.json || {});\nconst match = pickLatest(rows.filter(r => String(r.gmail_message_id||'') === id));\nreturn [{ json: match || {} }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1552,
        2064
      ],
      "id": "6fa12104-177a-4954-b6a3-47176e803fad",
      "name": "Load Session Row (History)"
    },
    {
      "parameters": {
        "resource": "thread",
        "operation": "get",
        "threadId": "={{ $('Load Session Row (History)').first().json.thread_id }}",
        "simple": false,
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1776,
        2064
      ],
      "id": "79290f94-c1a4-4e7b-970e-83fd2aac2605",
      "name": "Get Thread (History)",
      "webhookId": "163e796d-3c62-41a6-a662-b6c95eb875bb",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pick the last N message IDs from the Gmail thread\n// Output: multiple items like { messageId: '...' }\n\nconst N = 8; // set 3â€“10\n\nconst thread = $json || {};\nconst messages = Array.isArray(thread.messages) ? thread.messages : [];\n\nconst sorted = messages\n  .slice()\n  .sort((a, b) => Number(a.internalDate || 0) - Number(b.internalDate || 0));\n\nconst last = sorted.slice(-N);\n\nreturn last.map(m => ({\n  json: {\n    messageId: m.id,\n    internalDate: m.internalDate,\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        2064
      ],
      "id": "b63562b8-0c6d-4b1e-bb83-e8fb39daa66c",
      "name": "Pick Last N Msg IDs"
    },
    {
      "parameters": {
        "operation": "get",
        "messageId": "={{ $json.messageId }}",
        "simple": false,
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        2208,
        2064
      ],
      "id": "6c720aea-39d2-4003-b98c-804d7d405100",
      "name": "Get Message (History)",
      "webhookId": "5b1d6763-4360-4dbf-bbb1-28c7f420d6b5",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const N = 5; // 3â€“10\n\nconst tg = $('Telegram Trigger').first().json;\nconst chat_id = tg.callback_query?.message?.chat?.id;\nconst message_thread_id = tg.callback_query?.message?.message_thread_id;\n\nconst all = $input.all().map(i => i.json);\nall.sort((a, b) => Number(a.internalDate || 0) - Number(b.internalDate || 0));\nconst last = all.slice(-N);\n\nfunction decodeEntities(s = \"\") {\n  return s\n    .replace(/&#39;/g, \"'\")\n    .replace(/&quot;/g, '\"')\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/&#(\\d+);/g, (_, n) => String.fromCharCode(parseInt(n, 10)));\n}\n\n// remove leading \"From:\" / \"Subject:\" / \"Date:\" if Gmail header already has it\nfunction stripLabel(v = \"\", label = \"\") {\n  const re = new RegExp(\"^\\\\s*\" + label + \"\\\\s*:\\\\s*\", \"i\");\n  return String(v).replace(re, \"\").trim();\n}\n\nfunction getHeader(m, key) {\n  const h = m.headers || {};\n  return (h[key] || h[key.toLowerCase()] || \"\").toString().trim();\n}\n\nfunction shortenEmailAddress(from = \"\") {\n  // \"Name <email>\" -> \"Name\"\n  const m = from.match(/^(.+?)\\s*<.+>$/);\n  return (m ? m[1] : from).trim();\n}\n\nfunction cleanBody(s = \"\") {\n  s = decodeEntities(String(s));\n  s = s.replace(/\\r/g, \"\");\n\n  // cut off reply chains like: \"On ... wrote:\"\n  const cut = s.search(/\\nOn .+\\bwrote:\\s*$/im);\n  if (cut > 0) s = s.slice(0, cut);\n\n  // remove quoted lines starting with \">\"\n  s = s\n    .split(\"\\n\")\n    .filter(line => !/^\\s*>/.test(line))\n    .join(\"\\n\");\n\n  // compress extra blank lines\n  s = s.replace(/[ \\t]+\\n/g, \"\\n\");\n  s = s.replace(/\\n{3,}/g, \"\\n\\n\");\n  return s.trim();\n}\n\nfunction getBody(m) {\n  const body = m.textPlain || m.text || m.body || m.snippet || \"\";\n  return cleanBody(body);\n}\n\nfunction fmtDate(m) {\n  // prefer header date; fallback to internalDate\n  const d = stripLabel(getHeader(m, \"date\"), \"date\");\n  if (d) return d;\n  if (!m.internalDate) return \"\";\n  return new Date(Number(m.internalDate)).toLocaleString();\n}\n\nconst PER_EMAIL_LIMIT = 700; // keep each email short for telegram\n\nconst blocks = last.map((m, idx) => {\n  const fromRaw = stripLabel(getHeader(m, \"from\"), \"from\") || \"Unknown\";\n  const subjRaw = stripLabel(getHeader(m, \"subject\"), \"subject\") || \"(no subject)\";\n  const date = fmtDate(m);\n\n  const from = shortenEmailAddress(fromRaw);\n  const subj = subjRaw;\n\n  let body = getBody(m);\n  if (!body) body = \"(empty)\";\n\n  if (body.length > PER_EMAIL_LIMIT) body = body.slice(0, PER_EMAIL_LIMIT - 3) + \"...\";\n\n  return (\n    `(${idx + 1}/${last.length}) ${subj}\\n` +\n    `from: ${from}\\n` +\n    `date: ${date}\\n` +\n    `\\n${body}`\n  );\n});\n\nlet text = `ðŸ§¾ thread history (last ${last.length})\\n\\n` + blocks.join(\"\\n\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n\");\n\n// hard limit buffer\nif (text.length > 3800) text = text.slice(0, 3797) + \"...\";\n\nreturn [\n  {\n    json: {\n      chat_id,\n      message_thread_id,\n      history_text: text,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        2064
      ],
      "id": "47528d5e-e9d4-4f4a-9c9b-5a2d68ced205",
      "name": "Format History"
    },
    {
      "parameters": {
        "jsCode": "// Decide what to do next based on session mode + incoming update\nconst session = $json || {};\n\nreturn [{ json: { ...session, route: 'EDIT_NOW' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        5488
      ],
      "id": "8f58a875-82cf-4551-bb1b-605b4f6ad9d8",
      "name": "Decide Next Step"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "EDIT_NOW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "287b0a4f-7d25-48eb-9656-cce5ce8be08d"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1408,
        5488
      ],
      "id": "47e9b8ff-343a-4822-a806-e2b1165374fa",
      "name": "Route Next Step"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "9dbe4c28-21a6-4e14-8468-641b34211199",
              "leftValue": "={{ ( $('Execute a SQL query').first().json.telegram_message_ids || '' ).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3312,
        5488
      ],
      "id": "3d5f5f12-1c8b-4d73-b681-e51081ee8347",
      "name": "Has Stored Edit Msg IDs? (Edit)"
    },
    {
      "parameters": {
        "jsCode": "const row = $('Execute a SQL query').first().json;\nconst chatId = row.telegram_chat_id || $('Prepare Edit Data').first().json.chat_id || $('Parse Input').first().json.chat_id;\n\nconst listRaw = (row.telegram_message_ids || '').trim();\nconst extra = [\n  row.telegram_msg_id,\n  $('Prepare Edit Data').first().json.user_message_id,\n  $('Parse Input').first().json.message_id, // user edit message id (if any)\n];\n\nconst parts = [];\nif (listRaw) parts.push(...listRaw.split(','));\nfor (const e of extra) if (e != null && String(e).trim() !== '') parts.push(String(e));\n\nconst seen = new Set();\nreturn parts\n  .map(x => String(x).replace(/[^0-9]/g, ''))\n  .filter(x => x && !seen.has(x) && (seen.add(x), true))\n  .map(x => ({ json: { chat_id: chatId, message_id: Number(x) } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        5472
      ],
      "id": "1e2175e3-afae-4202-911d-219bf22c8582",
      "name": "Split Stored Edit Msg IDs (Edit)"
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3712,
        5472
      ],
      "id": "2319ec64-af8b-48c0-aec3-5370a969d4f1",
      "name": "Delete Stored Message (Edit)",
      "webhookId": "d7a9bb6c-e553-4b28-8e05-554e7775a6c5",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so the next steps run once\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3904,
        5472
      ],
      "id": "24c1f785-bc80-41e9-84d9-679b5f8f2fa4",
      "name": "Collapse After Deletes (Edit)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $('Append User Edit MsgId (body) (Get email_drafts)').first().json.gmail_message_id }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4128,
        5472
      ],
      "id": "837e2982-c292-4546-bcfa-76312c6415b6",
      "name": "Clear Stored Edit Msg IDs (Edit)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "resource": "draft",
        "operation": "delete",
        "messageId": "={{ $('Execute a SQL query').first().json.gmail_draft_id }}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        4720,
        5488
      ],
      "id": "0f10be10-4a56-4b90-addb-eaa9442247ac",
      "name": "Delete Old Gmail Draft",
      "webhookId": "b2c5d83f-f61c-4b3e-a2bc-351cc220c2b9",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ (() => { const s = $('Execute a SQL query').first().json.subject || ''; return (/^\\s*re:/i.test(s) ? s : 'Re: ' + s); })() }}",
        "message": "={{ $('Apply Edits (LLM)').first().json.output || '' }}",
        "options": {
          "threadId": "={{ $('Execute a SQL query').first().json.thread_id }}",
          "sendTo": "={{ ($('Execute a SQL query').first().json.from || '').match(/<([^>]+)>/)?.[1] || ($('Execute a SQL query').first().json.from || '').trim() }}\n"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        5008,
        5696
      ],
      "id": "3223c6e7-2486-4dd9-9457-edb23087de4b",
      "name": "Create Gmail Draft",
      "webhookId": "b1c2fe48-1048-4e3f-8466-ffafed814144",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ String($('Execute a SQL query').first().json.gmail_message_id) }}",
            "gmail_draft_id": "={{ String($('Create Gmail Draft').first().json.id) }}",
            "gmail_draft_message_id": "={{ String($('Create Gmail Draft').first().json.message?.id || '') }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5232,
        5696
      ],
      "id": "1bef28bd-abce-4a5c-8919-ec8c4ee8f10b",
      "name": "Store Gmail Draft IDs",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "c9474b33-48a1-463d-aced-63e0e83428cc",
              "leftValue": "={{ $('Execute a SQL query').first().json.gmail_draft_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4448,
        5680
      ],
      "id": "73851c25-2642-46ca-80da-949e04a192ba",
      "name": "Has Gmail Draft ID? (Edit)"
    },
    {
      "parameters": {
        "resource": "draft",
        "operation": "delete",
        "messageId": "={{ $('Execute a SQL query1').first().json.gmail_draft_id }}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        2480,
        1136
      ],
      "id": "a92e275f-9121-4cbc-b80d-e570d5f8fd60",
      "name": "Delete Old Gmail Draft1",
      "webhookId": "4f2e02ea-b00f-4c3d-a795-cb1ba669614a",
      "credentials": {
        "gmailOAuth2": {
          "id": "N8qlQv0i6oZyrA4p",
          "name": "Gmail account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {},
      "id": "e10e89d5-e1a0-4418-8a84-3fda6fc6eae2",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "position": [
        -48,
        6640
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "âœ… Done.\nEdit mode closed.\nNew emails are coming in again.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        2256,
        1136
      ],
      "id": "f26a0880-1f8a-48a3-8783-25d8d0107903",
      "name": "Send Done (Approve)",
      "webhookId": "018babe0-01a9-4333-9472-754a2c524de4",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice).",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "43ecf48f-011d-44cd-9448-f88da92173dc",
      "name": "Send Edit Mode Started Msg",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1824,
        1584
      ],
      "webhookId": "4aa4d904-0677-4aee-aa36-46f2d42142d8",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 473762709
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "mode": "waiting_edit",
            "pending_draft_id": "={{ (() => { try { return String($('Create Gmail Draft').first().json.id); } catch (e) { try { return String($('Check Edit Session').first().json.pending_draft_id || ''); } catch (e2) { return ''; } } })() }}",
            "field": "body",
            "expires_at": "={{ new Date(Date.now() + 5*60*1000).toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6768,
        5696
      ],
      "id": "721a6410-ddc5-43a1-8116-f90ff3b37de3",
      "name": "Extend Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœ… Approved. Sending now..."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1136,
        1136
      ],
      "id": "449cbdee-f20f-4869-8d87-5a4f27e3940b",
      "name": "Answer Callback (Approve)",
      "webhookId": "0c35bb8a-8030-4f01-a09a-d5ba3da7f4e4",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 473762709
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "confirm_msg_id": "={{ String($json.result.message_id) }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2048,
        1584
      ],
      "id": "90056cc0-eedc-41d2-ad51-0f33a134f877",
      "name": "Store Edit Mode MsgId",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2720,
        1584
      ],
      "id": "2d380b4e-28c6-4922-890a-5b4674546087",
      "name": "Append Bot MsgId (Edit Mode Started)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Execute a SQL query').first().json.telegram_chat_id }}",
        "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice).",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "1265ed4e-e6f6-460e-9943-37577462a56f",
      "name": "Send Edit Mode Started Msg1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        5648,
        5696
      ],
      "webhookId": "1124aff4-cc0b-4480-b792-20624021cf7b",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "ðŸŽ¨ Style menu"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1520,
        2800
      ],
      "id": "19945f49-beab-47d2-8293-40932c312dc9",
      "name": "Answer Callback (Style Menu)",
      "webhookId": "2709f0f2-127a-4826-88e1-e6c29e9b2a20",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Style preferences menu:",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸ“Œ Show",
                    "additionalFields": {
                      "callback_data": "style_show"
                    }
                  },
                  {
                    "text": "âœï¸ Set",
                    "additionalFields": {
                      "callback_data": "style_set"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "âž• Add",
                    "additionalFields": {
                      "callback_data": "style_add"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "âœ… Done",
                    "additionalFields": {
                      "callback_data": "style_done"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "52373378-ee62-4559-8374-e4b5c3c6b495",
      "name": "Send Style Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2176,
        2800
      ],
      "webhookId": "a1dd9d1e-e532-4caf-8409-5a518361c76c",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "ðŸ“Œ showing style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1520,
        3232
      ],
      "id": "6eb7d8e7-76e1-407e-8304-2cfdf06a80bf",
      "name": "Answer Callback (Style Show)",
      "webhookId": "5ddd36e4-731c-4b21-8ef1-b5070b45434e",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœï¸ set style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1552,
        3680
      ],
      "id": "ca2b3d2c-46a6-4d0b-8968-6f426fe0fda7",
      "name": "Answer Callback (Style Set)",
      "webhookId": "f5b532dc-bb52-4fa7-a60b-a29fe5eb0528",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âž• add style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1520,
        4112
      ],
      "id": "7ce6c534-a37c-4052-9375-4bede0fd6052",
      "name": "Answer Callback (Style Add)",
      "webhookId": "256c6925-fbf9-4821-9301-422743e4b7f9",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœ… Done. Cleaning up style messagesâ€¦"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1536,
        4576
      ],
      "id": "7ff7e941-53c4-47ee-b212-3f6661dcc111",
      "name": "Answer Callback (Style Done)",
      "webhookId": "962f83d3-3b4d-4e40-804e-5932b635068f",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1953836465
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "action": "SET",
            "scope": "user",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1744,
        3680
      ],
      "id": "07df8ff9-3bd2-4575-a4d9-5e818637fdeb",
      "name": "Style Pending - Upsert (SET)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1953836465
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "action": "ADD",
            "scope": "user",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1744,
        4112
      ],
      "id": "19e4f1df-c4d5-4c1b-8a84-0b367620278d",
      "name": "Style Pending - Upsert (ADD)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Send your style text now. (expires in 10 minutes)",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "3ff6439d-a47f-425b-939e-fd64e712616f",
      "name": "Send Style Prompt (Set)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1952,
        3680
      ],
      "webhookId": "791d0445-bcd7-432f-a761-455a627d9f4b",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Send extra style rules now. (expires in 10 minutes)",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "4ee61f32-0d74-44c6-9e99-5376c553f8ab",
      "name": "Send Style Prompt (Add)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1952,
        4112
      ],
      "webhookId": "22b4a6c3-39e2-42cb-88f1-b88973fa51db",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1953836465
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2816,
        4768
      ],
      "id": "59e7d67f-e50f-45b1-8ed4-e3f6c1dc0c96",
      "name": "Style Pending - Clear (button)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Get pending_actions (check)').all().map(i => i.json || {});\nconst active = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId && Date.parse(r.expires_at||'') > Date.now());\nconst latest = pickLatest(active);\nreturn [{ json: { has_pending: !!latest, action: latest ? latest.action : '', scope: latest ? latest.scope : '' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        6192
      ],
      "id": "991ace0a-93ca-4487-9db2-8b396b678609",
      "name": "Check Style Pending"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1586452316
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "scope": "={{ $json.scope }}",
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "prefs_text": "={{ $json.prefs_text }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "prefs_text",
              "displayName": "prefs_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2832,
        6192
      ],
      "id": "4b589abc-608d-4720-aa9e-81bd84556f4f",
      "name": "Apply Style Pending",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1953836465
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3056,
        6192
      ],
      "id": "87e8f6f7-8fc2-471f-a87f-1685b21c09fd",
      "name": "Style Pending - Clear (message)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "saved. iâ€™ll use this for future drafts.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "e0d61077-1f5d-4ed1-b554-75da6ac319b8",
      "name": "Send Style (Saved via pending)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3280,
        6192
      ],
      "webhookId": "17e73511-e9a4-47e3-8620-7f93146243a0",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1728,
        2800
      ],
      "id": "48a50148-a0d8-4fe0-930e-bb5781bd09f6",
      "name": "Style Session - Init Table (Menu)"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "message_ids": "",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1952,
        2800
      ],
      "id": "72501eb7-9f46-4b74-a95c-52830b172f2d",
      "name": "Style Session - Start (Menu)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2848,
        2800
      ],
      "id": "2ae378be-2f6e-47b3-bd60-c34df9c434d8",
      "name": "Style Session - Append MsgId (Bot)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2144,
        6192
      ],
      "id": "aa65b26d-2f4a-4f39-9b85-3cfe71a0bec0",
      "name": "Style Session - Append MsgId (User)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1744,
        4576
      ],
      "id": "526ae952-569d-40eb-8353-17f904d4ffd8",
      "name": "Style Session - Init Table (Done)"
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Get message_ids (done)').all().map(i => i.json || {});\nconst active = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId && Date.parse(r.expires_at||'') > Date.now());\nconst latest = pickLatest(active) || {};\nreturn [{ json: { message_ids: latest.message_ids || '' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        4576
      ],
      "id": "ab2c7086-4ec1-42c3-8eeb-9fee020359cd",
      "name": "Style Session - Get (Done)"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $('Parse Input').first().json.chat_id;\nconst raw = String($json.message_ids || '').trim();\nconst extra = [\n  $('Parse Input').first().json.telegram_msg_id,\n  $('Parse Input').first().json.message_id,\n];\nconst ids = [];\nconst pushId = (v) => {\n  const s = String(v ?? '').trim();\n  if (!s) return;\n  // keep digits only\n  const m = s.match(/\\d+/);\n  if (m) ids.push(m[0]);\n};\nif (raw) raw.split(',').forEach(pushId);\nextra.forEach(pushId);\n// unique\nconst uniq = Array.from(new Set(ids));\nreturn uniq.map(message_id => ({ json: { chat_id: chatId, message_id } }));\n"
      },
      "id": "2a54c455-f1f0-4ce5-a8e7-c34c13d0f030",
      "name": "Split Style Session Msg IDs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        4576
      ]
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "id": "a8c93e86-26d2-42bf-96e3-b9c41a018e70",
      "name": "Delete Style Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2528,
        4576
      ],
      "webhookId": "b6b4c49c-66ba-4740-9afe-8557be00c927",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "message_ids": "",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2816,
        4576
      ],
      "id": "ad7fd4fe-8f44-45b8-9c58-c2162c1c3982",
      "name": "Style Session - Clear (Done)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "APPROVE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8a627fc3-5300-4e85-a7ba-ded92f5a6a0e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "APPROVE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "EDIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0b0549a4-6c59-4b16-b0de-37340dad3921"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EDIT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "HISTORY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "81a38b93-e622-4041-a61c-32d0d396956e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HISTORY"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        416,
        1536
      ],
      "id": "c35c68d3-9d30-4aee-bd3d-1df15ef316e9",
      "name": "Button Action (Core)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_MENU",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c2f054ee-79a6-4935-9b89-6c424bdd8b7b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE MENU"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_SHOW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b51c50c2-06c5-40a6-949d-857d48fd1426"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE SHOW"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_SET",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "420ba027-4efd-4ccd-8d5e-507855ef0002"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE SET"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_ADD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "85089634-04f2-4d5f-af9b-daccb0930bd3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE ADD"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_DONE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6864225d-b1c0-4372-9855-46bcc4d4e55a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE DONE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        912,
        3104
      ],
      "id": "0c0cc3e0-d925-4ef4-b524-f78553ed0fc2",
      "name": "Button Action (Style)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2608,
        4112
      ],
      "id": "da561605-c549-489e-a222-2a391f11a846",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3968,
        6192
      ],
      "id": "e41587a6-4f36-461e-8825-d4c8eb48cd01",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst prefs = $('Get prefs (style show button)').all().map(i => i.json || {});\nconst modeRow = pickLatest(prefs.filter(r => r.scope === 'mode' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst mode = (modeRow && modeRow.prefs_text) ? String(modeRow.prefs_text) : 'user';\nconst userRow = pickLatest(prefs.filter(r => r.scope === 'user' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst chatRow = pickLatest(prefs.filter(r => r.scope === 'chat' && String(r.chat_id||'') === chatId && String(r.user_id||'') === ''));\nreturn [{ json: { chat_id: chatId, user_id: userId, mode, user_prefs: (userRow && userRow.prefs_text) || '', chat_prefs: (chatRow && chatRow.prefs_text) || '' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        3232
      ],
      "id": "1d081e45-e581-4f12-96e1-197488679a0f",
      "name": "Style - Show (SQL) (Button Action (Style))"
    },
    {
      "parameters": {
        "jsCode": "const mode = String($json.mode || 'user').toLowerCase();\nconst userPrefs = String($json.user_prefs || '').trim();\n\n\nconst modeLabel = (mode === 'chat') ? 'chat' : 'me';\n\nlet out = `User style:\\n${userPrefs ? userPrefs : '(empty)'}\\n\\n`;\n\n\nreturn [{ json: { ...$json, reply_text: out } }];"
      },
      "id": "e623f212-483c-48f8-92bc-1b3e1aff7bc6",
      "name": "Format Style Show (Style - Show (SQL) (Button Action (Style)))",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2384,
        3232
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.reply_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "9ba57333-8651-4e67-a636-9b2e0a364819",
      "name": "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2608,
        3232
      ],
      "webhookId": "f38d5914-c980-45af-a9cb-0bb221c823f9",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3280,
        3232
      ],
      "id": "bd36c5ac-94de-4ace-a979-150385f903ef",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style)))))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-haiku-4-5-20251001",
          "mode": "list",
          "cachedResultName": "Claude Haiku 4.5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        2976,
        5632
      ],
      "id": "54a144f7-57b8-4740-ac6c-3472d6d6e893",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "1ZrMc80LZuNYTpxa",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot8298402532:AAFCjmQZ9sQ88xArE_S16PiQtmQ1cabjWks/{{$json.result.file_path}}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2048,
        3344
      ],
      "id": "c44158c4-f018-4abd-aad0-6a4b3b9e18cb",
      "name": "Download Voice Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8547339878:AAHrRi1Vx0aWd547hel1VSZuS6Q3ooyQ_Y0/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.chat_id }}"
            },
            {
              "name": "message_thread_id",
              "value": "8"
            },
            {
              "name": "text",
              "value": "={{ $json.history_text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2672,
        2064
      ],
      "id": "e91342dc-3450-42ce-bd0b-f81d5e20d7e9",
      "name": "History Topic Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8298402532:AAFCjmQZ9sQ88xArE_S16PiQtmQ1cabjWks/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Execute a SQL query1').first().json.telegram_chat_id }}"
            },
            {
              "name": "message_thread_id",
              "value": "10"
            },
            {
              "name": "text",
              "value": "=âœ… {{   'Sent email:' + ($('Execute a SQL query1').first().json.draft_subject || '') +  '\\n\\nBody:\\n' + ($('Execute a SQL query1').first().json.draft_body || '')}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2928,
        1136
      ],
      "id": "0564825d-d742-4c59-b466-43e8ffdd3099",
      "name": "Sent Email Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8526061026:AAGl8wxM1P4mh4CBLSLiZeeE9sbcfxQuyRY/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "-1003772493573"
            },
            {
              "name": "message_thread_id",
              "value": " 20"
            },
            {
              "name": "text",
              "value": "âš ï¸ Sorry â€” the email assistant hit an error and couldnâ€™t send this email to Telegram. Please contact the product seller to fix it."
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        176,
        6640
      ],
      "id": "e6a72c1d-f781-4ed5-8d9e-8ca40ed98cbb",
      "name": "HTTP Request - Error Notice"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2432,
        5488
      ],
      "id": "62c42df4-5839-4f98-a611-fb1a97f3870d",
      "name": "Get email_drafts (edit)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1586452316
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2624,
        5488
      ],
      "id": "9d65d3a1-31b1-42d9-a60a-dcc441e211fb",
      "name": "Get prefs (edit)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1360,
        1136
      ],
      "id": "e1b8b555-f33d-4973-bcfc-7c6a02dcf53f",
      "name": "Get email_drafts (approve)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1328,
        2064
      ],
      "id": "d538203b-af4e-44f6-a698-55a8590d1b3b",
      "name": "Get email_drafts (history)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1586452316
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1776,
        3232
      ],
      "id": "91db556a-b2d0-487a-b7c3-f1f7cbe3e344",
      "name": "Get prefs (style show button)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1953836465
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1296,
        6192
      ],
      "id": "0c883625-2a2d-457e-b072-65419c0f6907",
      "name": "Get pending_actions (check)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1936,
        4576
      ],
      "id": "f33f9590-6dd8-4c65-b247-40aa8ef7e968",
      "name": "Get message_ids (done)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1776,
        5488
      ],
      "id": "be265bc1-1612-4a10-bd9a-dbb215bdb3ed",
      "name": "Append User Edit MsgId (body) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Prepare Edit Data').first().json.user_message_id || '');\nconst key = String($('Prepare Edit Data').first().json.draft_id || '');\nconst rows = $('Append User Edit MsgId (body) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        5488
      ],
      "id": "0a453735-f1c8-4a10-b21f-698c37685dfb",
      "name": "Append User Edit MsgId (body) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6096,
        5696
      ],
      "id": "4c7a64b4-bec0-43e5-b5e0-cd334f0b9208",
      "name": "Append Bot Draft MsgId (body) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Send Revised Draft').first().json.result.message_id || '');\nconst key = String($('Execute a SQL query').first().json.gmail_message_id || '');\nconst rows = $('Append Bot Draft MsgId (body) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6320,
        5696
      ],
      "id": "74433e81-cd42-4401-bb82-17882572fa01",
      "name": "Append Bot Draft MsgId (body) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "gid=0"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2272,
        1584
      ],
      "id": "0df8b8a5-45c9-4423-88ca-dcd14bfbca1c",
      "name": "Append Bot MsgId (Edit Mode Started) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Send Edit Mode Started Msg').first().json.result.message_id || '');\nconst key = String($('Parse Input').first().json.draft_id || '');\nconst rows = $('Append Bot MsgId (Edit Mode Started) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        1584
      ],
      "id": "b398fa39-96ea-4a00-8756-979eeff124bc",
      "name": "Append Bot MsgId (Edit Mode Started) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1586452316
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2384,
        6192
      ],
      "id": "a677d8b5-824c-4987-9a81-4c5f2986ec3d",
      "name": "Get prefs (style pending)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst scope = String($('Check Style Pending').first().json.scope || 'user');\nconst action = String($('Check Style Pending').first().json.action || 'SET');\nconst newText = String($('Parse Input').first().json.text || '');\nconst prefs = $('Get prefs (style pending)').all().map(i => i.json || {});\nconst targetUser = scope === 'chat' ? '' : userId;\nlet finalText = newText;\nif (action === 'ADD') {\n  const current = pickLatest(prefs.filter(r => r.scope === scope && String(r.chat_id||'') === chatId && String(r.user_id||'') === targetUser));\n  const curText = current && current.prefs_text ? String(current.prefs_text) : '';\n  finalText = curText ? (curText + '\\n' + newText) : newText;\n}\nreturn [{ json: { scope, chat_id: chatId, user_id: targetUser, prefs_text: finalText, updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2624,
        6192
      ],
      "id": "aa8d2734-91d5-42f9-9b0a-c8d7d692d41b",
      "name": "Apply Style Pending (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2400,
        2800
      ],
      "id": "a08dd045-0837-41bf-b150-9a64aa9576c9",
      "name": "Style Session - Append MsgId (Bot) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Send Style Menu').first().json.result?.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2624,
        2800
      ],
      "id": "e1686036-c962-4294-9392-32215db2999b",
      "name": "Style Session - Append MsgId (Bot) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1712,
        6192
      ],
      "id": "f1a91de7-6b59-4b4a-af1f-754628a7ce16",
      "name": "Style Session - Append MsgId (User) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (User) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Parse Input').first().json.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1920,
        6192
      ],
      "id": "5cf4956f-59df-47f5-bce5-5282a694091f",
      "name": "Style Session - Append MsgId (User) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2176,
        3680
      ],
      "id": "fd5532cd-c34e-4bc6-be23-3ec915b08193",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Send Style Prompt (Set)').first().json.result?.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        3680
      ],
      "id": "28238275-45eb-4922-81ed-a2580b88bd59",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2176,
        4112
      ],
      "id": "cd9cc97c-b127-44ee-b4a7-2ab5d39d9bc6",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Send Style Prompt (Add)').first().json.result?.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        4112
      ],
      "id": "b2a900c2-0e62-491b-8018-a39315a21a86",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3504,
        6192
      ],
      "id": "04481697-64f6-45e4-ac99-28a2393e1097",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Send Style (Saved via pending)').first().json.result?.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3728,
        6192
      ],
      "id": "6c258490-4570-4bdd-b40d-9e8366727eff",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": 1998009706
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2832,
        3232
      ],
      "id": "59a4227e-128d-412e-9ec0-34abdf4e5748",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "XoJf393CafMdwwSm",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst cur = String(latest.message_ids || '').trim();\nconst add = String($('Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))').first().json.result?.message_id || '');\nconst next = cur ? (cur + ',' + add) : add;\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: next, expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3056,
        3232
      ],
      "id": "ccc9402b-1cf8-48c3-a196-27fc26e37a23",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)"
    },
    {
      "parameters": {
        "content": "## VOICE INTAKE\n- Telegram Trigger receives messages.\n- Check if the message includes a voice file_id.\n- If yes: fetch the file and download the audio.\n- If no: skip this branch (handle text elsewhere).\n",
        "height": 384,
        "width": 848,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2768,
        3200
      ],
      "typeVersion": 1,
      "id": "2ab1ffbc-5cc6-4bc9-9706-c850d7238fa5",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## TRANSCRIBE AUDIO\n- Save the downloaded audio to disk.\n- Convert/prepare the audio file (command step).\n- Send audio to Deepgram for transcription.\n- Cleanup temporary voice files to save disk space.\n",
        "height": 480,
        "width": 1056,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1856,
        3072
      ],
      "typeVersion": 1,
      "id": "ee78323e-6829-4dda-b8a0-c8fc764847a0",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## PARSE + ROUTE\n- Parse the transcript into a clean text input.\n- Route by type (command / request / preference / other).\nThis makes voice input behave the same as typed input.\n",
        "height": 320,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -448,
        3232
      ],
      "typeVersion": 1,
      "id": "7110cfd3-2a8c-4b35-8f33-440b4cc281c6",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## BUTTON ACTION ROUTER\nUser clicks a Telegram button.\nWe answer the callback, then route to:\n- APPROVE: send the email\n- EDIT: start edit mode\n- HISTORY: show recent thread + session history\n",
        "height": 432,
        "width": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        352,
        1312
      ],
      "typeVersion": 1,
      "id": "db69a7dd-0adc-4224-b189-d12b89ac72de",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## APPROVE FLOW\n- Load the latest draft\n- Mark session approved/consumed\n- Confirm â€œDoneâ€ in Telegram\n- Delete old draft if needed\n- Send the reply email in Gmail\n- Notify sent status in Telegram\n",
        "height": 432,
        "width": 3264,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1088,
        912
      ],
      "typeVersion": 1,
      "id": "47311875-2d83-49ae-96f7-96bd6afe4d72",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## EDIT FLOW\n- Create/pick the latest edit session\n- Notify user that edit mode started\n- Save Telegram bot message IDs\nThese IDs are used later for cleanup.\n",
        "height": 384,
        "width": 1808,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1088,
        1408
      ],
      "typeVersion": 1,
      "id": "31358a79-4a69-4876-866a-0d73d55db1ad",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## HISTORY FLOW\n- Load session row + threadId\n- Fetch the thread and pick last N messages\n- Format a short history view\n- Send the history summary to Telegram\n",
        "height": 384,
        "width": 1744,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1088,
        1888
      ],
      "typeVersion": 1,
      "id": "42c2c147-5292-4b01-930b-0ce13bed5014",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## STYLE ACTION ROUTER\nRoutes by {{$json.action}} from Telegram buttons:\n- STYLE_MENU  â†’ show style menu + start session\n- STYLE_SHOW  â†’ show current style settings\n- STYLE_SET   â†’ ask user to set/replace style prefs\n- STYLE_ADD   â†’ ask user to add extra style rules\n- STYLE_DONE  â†’ exit style mode + cleanup messages\n",
        "height": 576,
        "width": 320
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        832,
        2784
      ],
      "typeVersion": 1,
      "id": "c354ce4d-dcae-4a9e-90db-81657e2a1ce2",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## STYLE_MENU (START)\n- Answer Telegram callback.\n- Create/initialize style session storage.\n- Send the style menu buttons to the user.\n- Save bot message IDs (for later cleanup).\n",
        "height": 368,
        "width": 1520,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1472,
        2624
      ],
      "typeVersion": 1,
      "id": "7afa6380-7bf4-408f-91b3-12fb050d8341",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## STYLE_SHOW (VIEW)\n- Load current writing/style preferences (sheet/SQL).\n- Format a readable summary.\n- Send it to Telegram.\n- Save bot message IDs.\n",
        "height": 368,
        "width": 1952,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1472,
        3056
      ],
      "typeVersion": 1,
      "id": "ecf77455-ae78-47c4-b466-892dffa5fa3f",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## STYLE_SET (REPLACE STYLE)\n- Answer Telegram callback.\n- Mark â€œstyle pending = SETâ€ (we are waiting for new style text).\n- Ask user to send their new writing/style preferences.\n- When user replies, we overwrite/replace the saved style rules.\n- Save bot message IDs for cleanup.\n",
        "height": 384,
        "width": 1088,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1488,
        3488
      ],
      "typeVersion": 1,
      "id": "3e558c13-34a6-4c14-b183-900a4bb0c8db",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "## STYLE_ADD (ADD MORE RULES)\n- Answer Telegram callback.\n- Mark â€œstyle pending = ADDâ€ (we are waiting for extra rules).\n- Ask user to send additional style instructions.\n- When user replies, we append the new rules to existing preferences.\n- Save bot message IDs for cleanup.\n",
        "height": 416,
        "width": 1312,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1472,
        3936
      ],
      "typeVersion": 1,
      "id": "fe9facf5-8b98-46c3-b4bb-bef01398de23",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## STYLE_DONE (CLEAN EXIT)\n- Fetch stored bot message IDs for this style session.\n- Delete those Telegram messages to keep chat clean.\n- Clear style session + clear any â€œpendingâ€ flags.\n",
        "height": 512,
        "width": 1488,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1488,
        4432
      ],
      "typeVersion": 1,
      "id": "211d9c53-0127-4bd2-99e0-f16c038298d9",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## CHECK EDIT SESSION (VALIDATE EDIT MODE)\nThese 3 nodes check whether the user is currently in an active edit session for this chat_id + user_id.\n\n### Check Edit Session (Google Sheets â€“ read: sheet)\n\n* Read the `edit_sessions` sheet.\n* Pull session rows for this chat/user (used to see if mode = waiting_edit and whether itâ€™s expired).\n\n### Code in JavaScript (Code)\n\n* Filter by `chat_id` + `user_id`.\n* Pick the latest session row.\n* Compare `expires_at` with current time.\n* Output `valid: true/false` + reason (OK / EXPIRED / NO_SESSION).\n\n### Session Valid? (IF)\n\n* True path = session is valid AND mode is `waiting_edit` (continue the edit flow).\n* False path = no session or expired (stop/route to normal flow).\n",
        "height": 720,
        "width": 608
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        560,
        4960
      ],
      "typeVersion": 1,
      "id": "50c95932-e130-4a77-9493-a3593cb13e2d",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## DRAFT EDIT (INPUT + ROUTE)\n- Decode incoming payload (chat_id user_id message_id text).\n- Route the â€œnext stepâ€ / intent (what the user wants to do next).\n- Build a clean draft-edit context object for downstream nodes.\n",
        "height": 320,
        "width": 512,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1200,
        5344
      ],
      "typeVersion": 1,
      "id": "9a92b6ab-9640-4ee8-bd6b-0ac920f2ef10",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "content": "## LOG + LOAD CONTEXT\n- Append user message + metadata to Sheets (history + message IDs).\n- Load latest draft state (draft_id subject body thread refs).\n- Load prefs_text (user/chat scope writing style rules).\n- Output a single context bundle for the LLM step.\n",
        "height": 368,
        "width": 1008,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1728,
        5312
      ],
      "typeVersion": 1,
      "id": "09f1e8d6-b0ac-4e0c-845d-c40f61762504",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "## GENERATE EDITED DRAFT (LLM)\n- Build the final prompt (original draft + user request + prefs_text).\n- Run LLM to produce the revised email draft text.\n- Return clean output ready for Gmail draft creation.\n",
        "height": 448,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2768,
        5328
      ],
      "typeVersion": 1,
      "id": "4a82cef3-aa0c-4713-abce-5fbf503a1adf",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## CLEANUP TEMP â€œDESIREDâ€ MESSAGE\nIf a temporary â€œdesired editâ€ message exists:\n- Split stored msg_ids into a list.\n- Delete those Telegram messages (keep chat clean).\n- Clear the stored desired-msg state so it wonâ€™t run again.\n",
        "height": 336,
        "width": 1008,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3248,
        5312
      ],
      "typeVersion": 1,
      "id": "9a46daed-beab-4e1f-8327-d3aad01db0d9",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "## UPDATE GMAIL DRAFT + SAVE STATE\n- If an old Gmail draft exists: delete it (avoid duplicates).\n- Create a new Gmail draft with the edited text.\n- Store the new draft_id/link back to Sheets.\n- Send review/preview message to Telegram.\n- Append bot msg_ids to Sheets for later cleanup.\n- Extend the edit session so user can continue editing.\n",
        "height": 560,
        "width": 2544,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4384,
        5312
      ],
      "typeVersion": 1,
      "id": "42ed5dd6-e980-4fc8-8a91-1f0ec5c78b5b",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "content": "## STYLE PENDING (APPLY USER MESSAGE)\nWhen the user sends a message, we check if a pending style action is active\nfor this chat_id + user_id (not expired).\n\nFlow:\n- Read pending action from sheet (SET or ADD + scope).\n- Validate pending is still active (not expired).\n- Load current prefs_text for the same scope.\n- Build final prefs_text:\n  SET = replace with userâ€™s new text\n  ADD = append userâ€™s text to existing prefs_text\n- Save updated prefs_text back to prefs sheet (update updated_at).\n- Clear/expire the pending record so it wonâ€™t run again.\n- Send confirmation: â€œsaved. iâ€™ll use this for future drafts.â€\n- Append msg_ids (user + bot) into style session log for cleanup.\n",
        "height": 544,
        "width": 2944,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1248,
        5840
      ],
      "typeVersion": 1,
      "id": "f93a6bea-25e3-49f0-994d-ea53cbcf061a",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "## ERROR HANDLER\n- TRIGGER ON WORKFLOW ERROR\n- SEND ALERT TO TELEGRAM (FAILED TOPIC)\n",
        "height": 320,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -80,
        6512
      ],
      "typeVersion": 1,
      "id": "e16881a2-f4b7-4293-a84f-db0ba7dfaa4d",
      "name": "Sticky Note20"
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Has Voice? (file_id)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Voice? (file_id)": {
      "main": [
        [
          {
            "node": "Get a file",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a file": {
      "main": [
        [
          {
            "node": "Download Voice Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk": {
      "main": [
        [
          {
            "node": "Execute a command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a command": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk1": {
      "main": [
        [
          {
            "node": "Deepgram Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deepgram Transcribe": {
      "main": [
        [
          {
            "node": "Cleanup voice files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cleanup voice files": {
      "main": [
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Input": {
      "main": [
        [
          {
            "node": "Route by Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Type": {
      "main": [
        [
          {
            "node": "Button Action (Core)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Button Action (Style)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Edit)": {
      "main": [
        [
          {
            "node": "Create Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Edit Session": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Valid?": {
      "main": [
        [
          {
            "node": "Decide Next Step",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get pending_actions (check)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Edit Data": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Edits (LLM)": {
      "main": [
        [
          {
            "node": "Has Stored Edit Msg IDs? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Revised Draft": {
      "main": [
        [
          {
            "node": "Send Edit Mode Started Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Draft in DB": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Session Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Apply Edits (LLM)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Consume Session (Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body)": {
      "main": [
        [
          {
            "node": "Get email_drafts (edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Stored Edit Msg IDs?": {
      "main": [
        [
          {
            "node": "Split Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Stored Edit Msg IDs": {
      "main": [
        [
          {
            "node": "Delete Stored User Edit Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Stored User Edit Message": {
      "main": [
        [
          {
            "node": "Collapse After Deletes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Deletes": {
      "main": [
        [
          {
            "node": "Clear Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body)": {
      "main": [
        [
          {
            "node": "Extend Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consume Session (Reply)": {
      "main": [
        [
          {
            "node": "Collapse After Consume (Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Consume (Reply)": {
      "main": [
        [
          {
            "node": "Send Done (Approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Email": {
      "main": [
        [
          {
            "node": "Sent Email Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Session Row (History)": {
      "main": [
        [
          {
            "node": "Get Thread (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Thread (History)": {
      "main": [
        [
          {
            "node": "Pick Last N Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format History": {
      "main": [
        [
          {
            "node": "History Topic Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Last N Msg IDs": {
      "main": [
        [
          {
            "node": "Get Message (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Message (History)": {
      "main": [
        [
          {
            "node": "Format History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decide Next Step": {
      "main": [
        [
          {
            "node": "Route Next Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Next Step": {
      "main": [
        [
          {
            "node": "Prepare Edit Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Stored Edit Msg IDs? (Edit)": {
      "main": [
        [
          {
            "node": "Split Stored Edit Msg IDs (Edit)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has Gmail Draft ID? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Stored Edit Msg IDs (Edit)": {
      "main": [
        [
          {
            "node": "Delete Stored Message (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Stored Message (Edit)": {
      "main": [
        [
          {
            "node": "Collapse After Deletes (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Deletes (Edit)": {
      "main": [
        [
          {
            "node": "Clear Stored Edit Msg IDs (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Stored Edit Msg IDs (Edit)": {
      "main": [
        [
          {
            "node": "Has Gmail Draft ID? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Gmail Draft": {
      "main": [
        [
          {
            "node": "Store Gmail Draft IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Gmail Draft IDs": {
      "main": [
        [
          {
            "node": "Send Revised Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Gmail Draft": {
      "main": [
        [
          {
            "node": "Create Gmail Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Gmail Draft ID? (Edit)": {
      "main": [
        [
          {
            "node": "Delete Old Gmail Draft",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Gmail Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Gmail Draft1": {
      "main": [
        [
          {
            "node": "Reply Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "HTTP Request - Error Notice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Done (Approve)": {
      "main": [
        [
          {
            "node": "Delete Old Gmail Draft1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Edit Session": {
      "main": [
        [
          {
            "node": "Pick Latest Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Latest Edit Session": {
      "main": [
        [
          {
            "node": "Send Edit Mode Started Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Approve)": {
      "main": [
        [
          {
            "node": "Get email_drafts (approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Edit Mode Started Msg": {
      "main": [
        [
          {
            "node": "Store Edit Mode MsgId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Edit Mode MsgId": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Edit Mode Started Msg1": {
      "main": [
        [
          {
            "node": "Update Draft in DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Upsert (SET)": {
      "main": [
        [
          {
            "node": "Send Style Prompt (Set)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Upsert (ADD)": {
      "main": [
        [
          {
            "node": "Send Style Prompt (Add)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Style Pending": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Style Pending": {
      "main": [
        [
          {
            "node": "Style Pending - Clear (message)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Clear (message)": {
      "main": [
        [
          {
            "node": "Send Style (Saved via pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Init Table (Menu)": {
      "main": [
        [
          {
            "node": "Style Session - Start (Menu)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Start (Menu)": {
      "main": [
        [
          {
            "node": "Send Style Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Menu": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User)": {
      "main": [
        [
          {
            "node": "Get prefs (style pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Init Table (Done)": {
      "main": [
        [
          {
            "node": "Get message_ids (done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Get (Done)": {
      "main": [
        [
          {
            "node": "Split Style Session Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Style Session Msg IDs": {
      "main": [
        [
          {
            "node": "Delete Style Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Style Message": {
      "main": [
        [
          {
            "node": "Style Session - Clear (Done)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Style Pending - Clear (button)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Prompt (Set)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Prompt (Add)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style (Saved via pending)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Action (Core)": {
      "main": [
        [
          {
            "node": "Answer Callback (Approve)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Edit)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Action (Style)": {
      "main": [
        [
          {
            "node": "Answer Callback (Style Menu)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Show)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Set)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Add)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style - Show (SQL) (Button Action (Style))": {
      "main": [
        [
          {
            "node": "Format Style Show (Style - Show (SQL) (Button Action (Style)))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Style Show (Style - Show (SQL) (Button Action (Style)))": {
      "main": [
        [
          {
            "node": "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Apply Edits (LLM)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice Telegram": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sent Email Telegram": {
      "main": [
        [
          {
            "node": "Has Stored Edit Msg IDs?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (edit)": {
      "main": [
        [
          {
            "node": "Get prefs (edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (edit)": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (approve)": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (history)": {
      "main": [
        [
          {
            "node": "Load Session Row (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (style show button)": {
      "main": [
        [
          {
            "node": "Style - Show (SQL) (Button Action (Style))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get pending_actions (check)": {
      "main": [
        [
          {
            "node": "Check Style Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get message_ids (done)": {
      "main": [
        [
          {
            "node": "Style Session - Get (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body) (Prepare)": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body) (Prepare)": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot MsgId (Edit Mode Started) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot MsgId (Edit Mode Started) (Prepare)": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (style pending)": {
      "main": [
        [
          {
            "node": "Apply Style Pending (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Style Pending (Prepare)": {
      "main": [
        [
          {
            "node": "Apply Style Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)": {
      "main": [
        []
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style)))))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (History)": {
      "main": [
        [
          {
            "node": "Get email_drafts (history)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Menu)": {
      "main": [
        [
          {
            "node": "Style Session - Init Table (Menu)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Show)": {
      "main": [
        [
          {
            "node": "Get prefs (style show button)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Set)": {
      "main": [
        [
          {
            "node": "Style Pending - Upsert (SET)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Add)": {
      "main": [
        [
          {
            "node": "Style Pending - Upsert (ADD)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Done)": {
      "main": [
        [
          {
            "node": "Style Session - Init Table (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "30a07ec5-2dea-47ec-8738-4c3a08ceaef2",
  "meta": {
    "instanceId": "c2319bcf64035e12fa4b23aa88003edd572c9ac2ee40ffdd07560e871f1375d3"
  },
  "id": "8Twr3BSEy7HdAKbQ",
  "tags": []
}