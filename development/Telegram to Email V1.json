{
  "name": "Telegram to Email V1",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -3808,
        2496
      ],
      "id": "01fe3d99-366a-4af5-9be5-100906867ae9",
      "name": "Telegram Trigger",
      "webhookId": "a2f99f2c-391e-4f54-b8f7-13829748f9e0",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "edff1973-e4e8-4740-a933-22ddafc2ff54",
              "leftValue": "={{ $json.message?.voice?.file_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -3584,
        2496
      ],
      "id": "cd0bff58-1e92-40c7-ad40-637885bf3bb2",
      "name": "Has Voice? (file_id)"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').first().json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3360,
        2432
      ],
      "id": "ddbd13b5-0a9c-4455-9448-dc0dd54ddf7d",
      "name": "Get a file",
      "webhookId": "0b34be1c-2808-435e-a435-01b594222fe3",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "=/files/voice.ogg",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -2912,
        2432
      ],
      "id": "97139dbd-9870-46e3-9ad0-2ab239cdaf34",
      "name": "Read/Write Files from Disk"
    },
    {
      "parameters": {
        "command": "=docker exec -i n8n-n8n1-1 sh -lc \"ffmpeg -y -hide_banner -loglevel error -i /files/voice.ogg -ac 1 -ar 16000 -c:a pcm_s16le /files/voice.wav\"\n"
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -2688,
        2432
      ],
      "id": "36f2a012-2e88-4056-b603-de5d595b1392",
      "name": "Execute a command",
      "credentials": {
        "sshPassword": {
          "id": "kYeNSNAxG8kXe2aK",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "fileSelector": "/files/voice.wav",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -2464,
        2432
      ],
      "id": "57c7c763-1634-4938-8815-31dde36f9034",
      "name": "Read/Write Files from Disk1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepgram.com/v1/listen?model=nova-2&smart_format=true&punctuate=true",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Token ' + $env.DEEPGRAM_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "audio/wav"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2240,
        2432
      ],
      "id": "bb72cf67-e23c-4544-868c-25f0d6db3b90",
      "name": "Deepgram Transcribe"
    },
    {
      "parameters": {
        "command": "docker exec -i n8n-n8n1-1 sh -lc \"rm -f /files/voice.ogg /files/voice.wav\""
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -2016,
        2432
      ],
      "id": "45949cef-9374-473e-8b5f-62f83ad0db88",
      "name": "Cleanup voice files",
      "credentials": {
        "sshPassword": {
          "id": "kYeNSNAxG8kXe2aK",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming Telegram update (button or message)\n// Voice transcript is read straight from the Deepgram node output\n\nlet trig = {};\ntry {\n  trig = $('Telegram Trigger').first().json ?? {};\n} catch (e) {\n  trig = $json ?? {};\n}\n\n// ---------- BUTTON CLICK ----------\nif (trig.callback_query) {\n  const cb = trig.callback_query;\n  const data = (cb.data || '').trim();\n  const [actionRaw, draftIdRaw] = data.split(':');\n\n  return [{\n    json: {\n      type: 'BUTTON',\n      action: (actionRaw || '').toUpperCase(),\n      draft_id: (draftIdRaw || '').trim(),\n      chat_id: cb.message?.chat?.id,\n      from_id: cb.from?.id,\n      telegram_msg_id: cb.message?.message_id,\n      callback_query_id: cb.id\n    }\n  }];\n}\n\n// ---------- MESSAGE ----------\nconst msg = trig.message || {};\nlet text = (msg.text || msg.caption || '').trim();\n\n// If it's a voice message, pull transcript directly from Deepgram node output\nif (!text && msg.voice?.file_id) {\n  try {\n    // IMPORTANT: change 'Deepgram' to your exact Deepgram node name (case-sensitive)\n    const dg = $('Deepgram Transcribe').first().json ?? {};\n\n    // Standard Deepgram transcript path (as in your screenshot)\n    text = (dg?.results?.channels?.[0]?.alternatives?.[0]?.transcript || '').trim();\n\n    // Fallback: rebuild sentence from (punctuated_)word list if transcript is empty\n    if (!text) {\n      const words = dg?.results?.channels?.[0]?.alternatives?.[0]?.words || [];\n      text = words\n        .map(w => (w?.punctuated_word || w?.word || '').trim())\n        .filter(Boolean)\n        .join(' ')\n        .trim();\n    }\n  } catch (e) {\n    text = '';\n  }\n}\n\nreturn [{\n  json: {\n    type: 'MESSAGE',\n    chat_id: msg.chat?.id,\n    from_id: msg.from?.id,\n    message_id: msg.message_id,\n    replied_to_message_id: msg.reply_to_message?.message_id,\n    text,\n    has_voice: !!msg.voice?.file_id,\n    voice_file_id: msg.voice?.file_id || null\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1488,
        2480
      ],
      "id": "3f6aabf3-9b84-47b3-9217-3c29fb82edb4",
      "name": "Parse Input"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "BUTTON",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f00886d1-fc52-4f5b-85d2-b20ecd611112"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "MESSAGE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f594f5b0-9f43-4e63-a65c-bfa3ed200937"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1296,
        2480
      ],
      "id": "6a070484-7725-4dd1-9490-97707121424b",
      "name": "Route by Type"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "pending_draft_id": "={{ String($('Parse Input').first().json.draft_id ?? '') }}",
            "mode": "waiting_edit",
            "expires_at": "={{ new Date(Date.now() + 5*60*1000).toISOString() }}",
            "field": "body"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        288,
        672
      ],
      "id": "ddec2835-80f2-468d-a554-c204473731ab",
      "name": "Create Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all().map(i => i.json || {});\nif (!rows.length) return [{ json: {} }];\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst filtered = rows.filter(r => String(r.chat_id||'') === chatId);\nconst list = filtered.length ? filtered : rows;\nconst sorted = list.map(r => ({ r, t: Date.parse(r.expires_at || '') })).sort((a,b)=> (a.t||0)-(b.t||0));\nreturn [{ json: sorted[sorted.length - 1].r }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        672
      ],
      "id": "e7d98e85-ca27-47dd-ad25-19859612f5d7",
      "name": "Pick Latest Edit Session"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice)."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        64,
        672
      ],
      "id": "1ddef2a0-7f3e-4f77-a643-2fdd7b2938ae",
      "name": "Answer Callback (Edit)",
      "webhookId": "40eca8ee-8613-4575-9689-c6dd1d4b0125",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -496,
        4592
      ],
      "id": "8b84058f-13df-4e36-8e60-9b3b9b3e28ef",
      "name": "Check Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "1c226fd0-ebe8-48c6-9d54-ced3096b0564"
            },
            {
              "leftValue": "={{ (() => { const mode = ($json.mode || '').toLowerCase(); return mode === 'waiting_edit'; })() }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "3dc1dd69-5c16-42c3-96cb-1ada4d1ea574"
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -112,
        4592
      ],
      "id": "c129ce64-6ee3-4f2a-9f26-a43045c84d54",
      "name": "Session Valid?"
    },
    {
      "parameters": {
        "jsCode": "// Build edit payload from session + incoming message\nconst session = $('Check Edit Session').first().json || {};\nconst incoming = $('Parse Input').first().json || {};\n\nconst instruction = (incoming.text || '').trim();\n\nreturn [{\n  json: {\n    draft_id: session.pending_draft_id,\n    edit_instruction: instruction,\n    chat_id: incoming.chat_id,\n    from_id: incoming.from_id,\n    // MESSAGE: message_id, BUTTON: telegram_msg_id\n    user_message_id: incoming.message_id || incoming.telegram_msg_id\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        4576
      ],
      "id": "272a1cfb-649f-423d-b269-11ab7885a121",
      "name": "Prepare Edit Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Writing preferences (follow strictly): {{ $json.prefs_text || '' }}\n\nEdit instruction: {{ $('Prepare Edit Data').first().json.edit_instruction }}\n\nCurrent draft:\n{{ $json.draft_body }}",
        "options": {
          "systemMessage": "You are an email editing assistant. Apply the user's edit instruction to the current draft.\n\nCore rules:\n- Output ONLY the revised email body\n- Apply the requested changes precisely\n- Maintain professional tone\n- Keep the greeting and signature format\n- If instruction is unclear, make your best interpretation\n\nOutput the complete revised email body, ready to send."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1888,
        4576
      ],
      "id": "c49697a0-2b0f-4729-ab43-cccc9f44af99",
      "name": "Apply Edits (LLM)"
    },
    {
      "parameters": {
        "chatId": "={{ $('Execute a SQL query').first().json.telegram_chat_id }}",
        "text": "={{ (() => {\n  const row = $('Execute a SQL query').first().json || {};\n\n  const rawCat = row.categoy || row.category || 'FYI';\n  const norm = String(rawCat).toUpperCase().trim().replace(/[\\s_]+/g, '_');\n  const displayCat = norm.replace(/_/g, ' ');\n\n  const from = row.from || 'Unknown';\n  const subject = row.subject || 'No subject';\n\n  let summary = '';\n  let message = '';\n  const old = row.old_email || '';\n\n  try {\n    const obj = JSON.parse(old);\n    summary = obj.summary || '';\n    message = obj.message || '';\n  } catch (e) {\n    message = old;\n  }\n\n  const redraft = $('Apply Edits (LLM)').first().json.output || '';\n\n  let out = `Category: ${displayCat}\\nFrom: ${from}\\nSubject: ${subject}\\n\\n`;\n  if (summary) out += `Summary: ${summary}\\n\\n`;\n  if (message) out += `Message:\\n${message}\\n\\n`;\n  out += `Redraft:\\n${redraft}`;\n\n  return out.trim();\n})() }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "âœ… Approve",
                    "additionalFields": {
                      "callback_data": "={{ 'approve:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  },
                  {
                    "text": "âœï¸ Edit",
                    "additionalFields": {
                      "callback_data": "={{ 'edit:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸŽ¨ Style",
                    "additionalFields": {
                      "callback_data": "style_menu"
                    }
                  },
                  {
                    "text": "ðŸ§¾ History",
                    "additionalFields": {
                      "callback_data": "={{ 'history:' + $('Execute a SQL query').first().json.gmail_message_id }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4352,
        4784
      ],
      "id": "70f3b20f-e9df-4341-8728-1bb3458c7942",
      "name": "Send Revised Draft",
      "webhookId": "cc84e9e6-8f3c-4291-8871-fcbb2f914345",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $('Execute a SQL query').first().json.gmail_message_id }}",
            "draft_body": "={{ $('Apply Edits (LLM)').first().json.output }}",
            "status": "revised",
            "telegram_msg_id": "={{ $json.result.message_id }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4784,
        4784
      ],
      "id": "1e102baf-21e4-4bd9-a159-7ab18a5018e1",
      "name": "Update Draft in DB",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const all = $input.all().map(i => i.json || {});\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = all.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nif (!rows.length) {\n  return [{ json: { valid: false, reason: 'NO_SESSION' } }];\n}\nconst withExp = rows.map(r => ({ r, t: Date.parse(r.expires_at || '') })).sort((a,b) => (a.t||0)-(b.t||0));\nconst latest = withExp[withExp.length - 1].r;\nconst now = Date.now();\nconst expiresMs = Date.parse(latest.expires_at || '');\nconst valid = Number.isFinite(expiresMs) && expiresMs > now;\nreturn [{ json: Object.assign({}, latest, { valid, reason: valid ? 'OK' : 'EXPIRED' }) }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        4592
      ],
      "id": "837cb872-65cd-4e35-acc2-34cacfc34213",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst draftId = String($('Check Edit Session').first().json.pending_draft_id || '');\nconst chatId = String($('Prepare Edit Data').first().json.chat_id || $('Parse Input').first().json.chat_id || '');\nconst userId = String($('Prepare Edit Data').first().json.from_id || $('Parse Input').first().json.from_id || '');\nconst drafts = $('Get email_drafts (edit)').all().map(i => i.json || {});\nconst row = drafts.find(r => String(r.gmail_draft_id || '') === draftId || String(r.gmail_message_id || '') === draftId) || {};\nconst prefs = $('Get prefs (edit)').all().map(i => i.json || {});\nconst modeRow = pickLatest(prefs.filter(r => r.scope === 'mode' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst mode = (modeRow && modeRow.prefs_text) ? String(modeRow.prefs_text) : 'user';\nlet prefRow = null;\nif (mode === 'chat') {\n  prefRow = pickLatest(prefs.filter(r => r.scope === 'chat' && String(r.chat_id||'') === chatId && String(r.user_id||'') === ''));\n} else {\n  prefRow = pickLatest(prefs.filter(r => r.scope === 'user' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\n}\nconst prefs_text = (prefRow && typeof prefRow.prefs_text === 'string') ? prefRow.prefs_text : '';\nreturn [{ json: Object.assign({}, row, { prefs_text }) }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        4576
      ],
      "id": "0fc12be9-9e73-4512-8fd1-086003653b99",
      "name": "Execute a SQL query"
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst id = String($('Button Action (Core)').first().json.draft_id || '');\nconst rows = $('Get email_drafts (approve)').all().map(i => i.json || {});\nconst match = pickLatest(rows.filter(r => String(r.gmail_message_id||'') === id));\nreturn [{ json: match || {} }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        224
      ],
      "id": "1a660ec6-9b5c-48fe-b7b5-636f378c6a56",
      "name": "Execute a SQL query1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1136,
        4576
      ],
      "id": "ee46dd0f-c08b-4512-a197-49555c9d0150",
      "name": "Append User Edit MsgId (body)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "9dbe4c28-21a6-4e14-8468-641b34211199",
              "leftValue": "={{ ( $('Execute a SQL query1').first().json.telegram_message_ids || '' ).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2064,
        224
      ],
      "id": "d46d6eb1-e11d-4a20-a9aa-2da3cec0093c",
      "name": "Has Stored Edit Msg IDs?"
    },
    {
      "parameters": {
        "jsCode": "const row = $('Execute a SQL query1').first().json;\nconst chatId = $('Parse Input').first().json.chat_id;\n\n// accept multiple possible DB column names and types\nconst stored = row.telegram_message_ids ?? row.telegram_msg_ids ?? row.telegram_msg_id ?? '';\n\nlet parts = [];\nif (Array.isArray(stored)) {\n  parts = stored.map(String);\n} else if (typeof stored === 'string') {\n  parts = stored.split(',').map(s => s.trim()).filter(Boolean);\n} else if (stored != null) {\n  parts = [String(stored)];\n}\n\nconst extra = [\n  row.telegram_msg_id,\n  $('Parse Input').first().json.message_id, // clicked approve message id\n];\n\nfor (const e of extra) {\n  if (e != null && String(e).trim() !== '') parts.push(String(e));\n}\n\nconst seen = new Set();\nreturn parts\n  .map(x => String(x).replace(/[^0-9]/g, ''))\n  .filter(x => x && !seen.has(x) && (seen.add(x), true))\n  .map(x => ({ json: { chat_id: chatId, message_id: Number(x) } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2288,
        224
      ],
      "id": "73518daa-2013-4fed-948c-ec2a73f6caea",
      "name": "Split Stored Edit Msg IDs"
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2576,
        224
      ],
      "id": "5cee8124-d974-4b40-b80b-6f0c531233a5",
      "name": "Delete Stored User Edit Message",
      "webhookId": "2c6bd583-8502-41c0-aab0-dbe9f6dfee27",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ String($('Execute a SQL query1').first().json.gmail_message_id || '') }}",
            "telegram_message_ids": ""
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3088,
        224
      ],
      "id": "5d1980d4-2f71-4372-965d-cb6c249cbae9",
      "name": "Clear Stored Edit Msg IDs",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so the next steps run once\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2864,
        224
      ],
      "id": "ab22bda1-b8cb-4b14-85e6-4bb2c3924caa",
      "name": "Collapse After Deletes"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5456,
        4784
      ],
      "id": "5f31fa23-2ff1-4fba-9663-3b19617c88da",
      "name": "Append Bot Draft MsgId (body)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "mode": "Consumed",
            "expires_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        720,
        224
      ],
      "id": "3622335d-f300-46fc-b2fb-fe5123ba7f3e",
      "name": "Consume Session (Reply)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so downstream actions run once.\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        224
      ],
      "id": "098154df-01cc-48c4-b392-d8966640cdf6",
      "name": "Collapse After Consume (Reply)"
    },
    {
      "parameters": {
        "resource": "thread",
        "operation": "reply",
        "threadId": "={{ $('Execute a SQL query1').first().json.thread_id }}",
        "messageId": "={{ $('Execute a SQL query1').first().json.gmail_message_id }}",
        "message": "={{ $('Execute a SQL query1').first().json.draft_body }}",
        "options": {
          "replyToSenderOnly": true
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1616,
        224
      ],
      "id": "4f7732ea-a3b9-4e8d-ba2a-3c35b7a12300",
      "name": "Reply Email",
      "webhookId": "61094943-b676-495d-8a3d-5d07d9f79126",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "Loading history..."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        32,
        1152
      ],
      "id": "9e35855f-dc6a-4961-bf2a-305e2bfec158",
      "name": "Answer Callback (History)",
      "webhookId": "ea798b3e-c01a-4444-87be-2cda75ef2cdf",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst id = String($('Button Action (Core)').first().json.draft_id || '');\nconst rows = $('Get email_drafts (history)').all().map(i => i.json || {});\nconst match = pickLatest(rows.filter(r => String(r.gmail_message_id||'') === id));\nreturn [{ json: match || {} }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        1152
      ],
      "id": "1adb3c14-9460-4cef-8ae5-bfe182b5822d",
      "name": "Load Session Row (History)"
    },
    {
      "parameters": {
        "resource": "thread",
        "operation": "get",
        "threadId": "={{ $('Load Session Row (History)').first().json.thread_id }}",
        "simple": false,
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        688,
        1152
      ],
      "id": "73ce7b83-a4a0-4730-b960-80fed8b5c924",
      "name": "Get Thread (History)",
      "webhookId": "163e796d-3c62-41a6-a662-b6c95eb875bb",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pick the last N message IDs from the Gmail thread\n// Output: multiple items like { messageId: '...' }\n\nconst N = 8; // set 3â€“10\n\nconst thread = $json || {};\nconst messages = Array.isArray(thread.messages) ? thread.messages : [];\n\nconst sorted = messages\n  .slice()\n  .sort((a, b) => Number(a.internalDate || 0) - Number(b.internalDate || 0));\n\nconst last = sorted.slice(-N);\n\nreturn last.map(m => ({\n  json: {\n    messageId: m.id,\n    internalDate: m.internalDate,\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        1152
      ],
      "id": "d3e1555c-7c17-4da5-a857-495a33d9dd0b",
      "name": "Pick Last N Msg IDs"
    },
    {
      "parameters": {
        "operation": "get",
        "messageId": "={{ $json.messageId }}",
        "simple": false,
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1120,
        1152
      ],
      "id": "7e82f16e-0dd8-4018-b578-ddf0c2907fca",
      "name": "Get Message (History)",
      "webhookId": "5b1d6763-4360-4dbf-bbb1-28c7f420d6b5",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const N = 5; // 3â€“10\n\nconst tg = $('Telegram Trigger').first().json;\nconst chat_id = tg.callback_query?.message?.chat?.id;\nconst message_thread_id = tg.callback_query?.message?.message_thread_id;\n\nconst all = $input.all().map(i => i.json);\nall.sort((a, b) => Number(a.internalDate || 0) - Number(b.internalDate || 0));\nconst last = all.slice(-N);\n\nfunction decodeEntities(s = \"\") {\n  return s\n    .replace(/&#39;/g, \"'\")\n    .replace(/&quot;/g, '\"')\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/&#(\\d+);/g, (_, n) => String.fromCharCode(parseInt(n, 10)));\n}\n\n// remove leading \"From:\" / \"Subject:\" / \"Date:\" if Gmail header already has it\nfunction stripLabel(v = \"\", label = \"\") {\n  const re = new RegExp(\"^\\\\s*\" + label + \"\\\\s*:\\\\s*\", \"i\");\n  return String(v).replace(re, \"\").trim();\n}\n\nfunction getHeader(m, key) {\n  const h = m.headers || {};\n  return (h[key] || h[key.toLowerCase()] || \"\").toString().trim();\n}\n\nfunction shortenEmailAddress(from = \"\") {\n  // \"Name <email>\" -> \"Name\"\n  const m = from.match(/^(.+?)\\s*<.+>$/);\n  return (m ? m[1] : from).trim();\n}\n\nfunction cleanBody(s = \"\") {\n  s = decodeEntities(String(s));\n  s = s.replace(/\\r/g, \"\");\n\n  // cut off reply chains like: \"On ... wrote:\"\n  const cut = s.search(/\\nOn .+\\bwrote:\\s*$/im);\n  if (cut > 0) s = s.slice(0, cut);\n\n  // remove quoted lines starting with \">\"\n  s = s\n    .split(\"\\n\")\n    .filter(line => !/^\\s*>/.test(line))\n    .join(\"\\n\");\n\n  // compress extra blank lines\n  s = s.replace(/[ \\t]+\\n/g, \"\\n\");\n  s = s.replace(/\\n{3,}/g, \"\\n\\n\");\n  return s.trim();\n}\n\nfunction getBody(m) {\n  const body = m.textPlain || m.text || m.body || m.snippet || \"\";\n  return cleanBody(body);\n}\n\nfunction fmtDate(m) {\n  // prefer header date; fallback to internalDate\n  const d = stripLabel(getHeader(m, \"date\"), \"date\");\n  if (d) return d;\n  if (!m.internalDate) return \"\";\n  return new Date(Number(m.internalDate)).toLocaleString();\n}\n\nconst PER_EMAIL_LIMIT = 700; // keep each email short for telegram\n\nconst blocks = last.map((m, idx) => {\n  const fromRaw = stripLabel(getHeader(m, \"from\"), \"from\") || \"Unknown\";\n  const subjRaw = stripLabel(getHeader(m, \"subject\"), \"subject\") || \"(no subject)\";\n  const date = fmtDate(m);\n\n  const from = shortenEmailAddress(fromRaw);\n  const subj = subjRaw;\n\n  let body = getBody(m);\n  if (!body) body = \"(empty)\";\n\n  if (body.length > PER_EMAIL_LIMIT) body = body.slice(0, PER_EMAIL_LIMIT - 3) + \"...\";\n\n  return (\n    `(${idx + 1}/${last.length}) ${subj}\\n` +\n    `from: ${from}\\n` +\n    `date: ${date}\\n` +\n    `\\n${body}`\n  );\n});\n\nlet text = `ðŸ§¾ thread history (last ${last.length})\\n\\n` + blocks.join(\"\\n\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n\");\n\n// hard limit buffer\nif (text.length > 3800) text = text.slice(0, 3797) + \"...\";\n\nreturn [\n  {\n    json: {\n      chat_id,\n      message_thread_id,\n      history_text: text,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        1152
      ],
      "id": "491b3c8e-b202-49dc-af5f-441509f3f367",
      "name": "Format History"
    },
    {
      "parameters": {
        "jsCode": "// Decide what to do next based on session mode + incoming update\nconst session = $json || {};\n\nreturn [{ json: { ...session, route: 'EDIT_NOW' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        4576
      ],
      "id": "18ab711d-532b-4fe9-9a39-adf7c3ceb8f1",
      "name": "Decide Next Step"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "EDIT_NOW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "287b0a4f-7d25-48eb-9656-cce5ce8be08d"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        320,
        4576
      ],
      "id": "b0510b00-ff2a-499c-8d74-e72aa4b82b98",
      "name": "Route Next Step"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "9dbe4c28-21a6-4e14-8468-641b34211199",
              "leftValue": "={{ ( $('Execute a SQL query').first().json.telegram_message_ids || '' ).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2224,
        4576
      ],
      "id": "4cc470bd-b802-468a-9213-c572549a9a6f",
      "name": "Has Stored Edit Msg IDs? (Edit)"
    },
    {
      "parameters": {
        "jsCode": "const row = $('Execute a SQL query').first().json;\nconst chatId = row.telegram_chat_id || $('Prepare Edit Data').first().json.chat_id || $('Parse Input').first().json.chat_id;\n\nconst listRaw = (row.telegram_message_ids || '').trim();\nconst extra = [\n  row.telegram_msg_id,\n  $('Prepare Edit Data').first().json.user_message_id,\n  $('Parse Input').first().json.message_id, // user edit message id (if any)\n];\n\nconst parts = [];\nif (listRaw) parts.push(...listRaw.split(','));\nfor (const e of extra) if (e != null && String(e).trim() !== '') parts.push(String(e));\n\nconst seen = new Set();\nreturn parts\n  .map(x => String(x).replace(/[^0-9]/g, ''))\n  .filter(x => x && !seen.has(x) && (seen.add(x), true))\n  .map(x => ({ json: { chat_id: chatId, message_id: Number(x) } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        4560
      ],
      "id": "0a361792-8c08-4985-b69a-9eb832742e7c",
      "name": "Split Stored Edit Msg IDs (Edit)"
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2624,
        4560
      ],
      "id": "5fd36a12-fd13-460e-9e7c-f0a83c630bab",
      "name": "Delete Stored Message (Edit)",
      "webhookId": "d7a9bb6c-e553-4b28-8e05-554e7775a6c5",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Collapse to a single item so the next steps run once\nreturn [items[0] ?? { json: {} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2816,
        4560
      ],
      "id": "d7638693-dec2-4cb7-ab1e-6319e563654c",
      "name": "Collapse After Deletes (Edit)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $('Append User Edit MsgId (body) (Get email_drafts)').first().json.gmail_message_id }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3040,
        4560
      ],
      "id": "1d113166-aa2a-4669-a2de-077827e85af1",
      "name": "Clear Stored Edit Msg IDs (Edit)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "resource": "draft",
        "operation": "delete",
        "messageId": "={{ $('Execute a SQL query').first().json.gmail_draft_id }}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        3632,
        4576
      ],
      "id": "b7a1c64e-b677-450c-bb4b-9f728acb5c06",
      "name": "Delete Old Gmail Draft",
      "webhookId": "b2c5d83f-f61c-4b3e-a2bc-351cc220c2b9",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ (() => { const s = $('Execute a SQL query').first().json.subject || ''; return (/^\\s*re:/i.test(s) ? s : 'Re: ' + s); })() }}",
        "message": "={{ $('Apply Edits (LLM)').first().json.output || '' }}",
        "options": {
          "threadId": "={{ $('Execute a SQL query').first().json.thread_id }}",
          "sendTo": "={{ ($('Execute a SQL query').first().json.from || '').match(/<([^>]+)>/)?.[1] || ($('Execute a SQL query').first().json.from || '').trim() }}\n"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        3920,
        4784
      ],
      "id": "4c1a7307-d263-4748-a28d-cfec1e312efe",
      "name": "Create Gmail Draft",
      "webhookId": "b1c2fe48-1048-4e3f-8466-ffafed814144",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ String($('Execute a SQL query').first().json.gmail_message_id) }}",
            "gmail_draft_id": "={{ String($('Create Gmail Draft').first().json.id) }}",
            "gmail_draft_message_id": "={{ String($('Create Gmail Draft').first().json.message?.id || '') }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4144,
        4784
      ],
      "id": "e4474165-3d2e-4307-85bc-9b141b894d56",
      "name": "Store Gmail Draft IDs",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "c9474b33-48a1-463d-aced-63e0e83428cc",
              "leftValue": "={{ $('Execute a SQL query').first().json.gmail_draft_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3360,
        4768
      ],
      "id": "88f835c4-cef1-4649-b98b-ad3c182b032d",
      "name": "Has Gmail Draft ID? (Edit)"
    },
    {
      "parameters": {
        "resource": "draft",
        "operation": "delete",
        "messageId": "={{ $('Execute a SQL query1').first().json.gmail_draft_id }}"
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1392,
        224
      ],
      "id": "e11cd7fc-5b44-48c3-b129-660d23f2d4e1",
      "name": "Delete Old Gmail Draft1",
      "webhookId": "4f2e02ea-b00f-4c3d-a795-cb1ba669614a",
      "credentials": {
        "gmailOAuth2": {
          "id": "7fEUhp2kEXidWc5A",
          "name": "Gmail account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {},
      "id": "dc44cb04-beb7-4f72-939f-d01556dc077b",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "position": [
        -1136,
        5728
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "âœ… Done.\nEdit mode closed.\nNew emails are coming in again.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1168,
        224
      ],
      "id": "3cdde04c-081d-4953-aeb5-804c69006677",
      "name": "Send Done (Approve)",
      "webhookId": "018babe0-01a9-4333-9472-754a2c524de4",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice).",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "e4ada6b3-0e80-4b9a-ad5e-8b9483d8898e",
      "name": "Send Edit Mode Started Msg",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        736,
        672
      ],
      "webhookId": "4aa4d904-0677-4aee-aa36-46f2d42142d8",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "mode": "waiting_edit",
            "pending_draft_id": "={{ (() => { try { return String($('Create Gmail Draft').first().json.id); } catch (e) { try { return String($('Check Edit Session').first().json.pending_draft_id || ''); } catch (e2) { return ''; } } })() }}",
            "field": "body",
            "expires_at": "={{ new Date(Date.now() + 5*60*1000).toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5680,
        4784
      ],
      "id": "301c1713-d589-4649-bf38-fa56f90746e7",
      "name": "Extend Edit Session",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœ… Approved. Sending now..."
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        48,
        224
      ],
      "id": "7d4fc5e3-79a8-4da3-bb7d-a09a4cc13789",
      "name": "Answer Callback (Approve)",
      "webhookId": "0c35bb8a-8030-4f01-a09a-d5ba3da7f4e4",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 473762709,
          "mode": "list",
          "cachedResultName": "edit_sessions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id ?? '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id ?? '') }}",
            "confirm_msg_id": "={{ String($json.result.message_id) }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_draft_id",
              "displayName": "pending_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mode",
              "displayName": "mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_transcript",
              "displayName": "pending_transcript",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "confirm_msg_id",
              "displayName": "confirm_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voice_file_id",
              "displayName": "voice_file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_questions",
              "displayName": "pending_questions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pending_answers",
              "displayName": "pending_answers",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        960,
        672
      ],
      "id": "bbaa97fe-f713-4e28-be25-736c8f5ef6f6",
      "name": "Store Edit Mode MsgId",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "gmail_message_id": "={{ $json.gmail_message_id }}",
            "telegram_message_ids": "={{ $json.telegram_message_ids }}"
          },
          "matchingColumns": [
            "gmail_message_id"
          ],
          "schema": [
            {
              "id": "gmail_message_id",
              "displayName": "gmail_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "from",
              "displayName": "from",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subject",
              "displayName": "subject",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "draft_body",
              "displayName": "draft_body",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_msg_id",
              "displayName": "telegram_msg_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_message_ids",
              "displayName": "telegram_message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "categoy",
              "displayName": "categoy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "old_email",
              "displayName": "old_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_id",
              "displayName": "gmail_draft_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "gmail_draft_message_id",
              "displayName": "gmail_draft_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1632,
        672
      ],
      "id": "be2e4ebc-b3c3-4d63-9df0-68041108b8c8",
      "name": "Append Bot MsgId (Edit Mode Started)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Execute a SQL query').first().json.telegram_chat_id }}",
        "text": "âœï¸ Edit mode started (5:00).\nNew emails are paused until the timer ends or you tap âœ… Approve.\n\nSend your edit instructions now (text or voice).",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "d6da1c91-a835-4450-9202-d4b0189e6ee9",
      "name": "Send Edit Mode Started Msg1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        4560,
        4784
      ],
      "webhookId": "1124aff4-cc0b-4480-b792-20624021cf7b",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "ðŸŽ¨ Style menu"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        432,
        1888
      ],
      "id": "1dd271c2-ea0b-49d1-a639-9082eaaab0d3",
      "name": "Answer Callback (Style Menu)",
      "webhookId": "2709f0f2-127a-4826-88e1-e6c29e9b2a20",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Style preferences menu:",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "ðŸ“Œ Show",
                    "additionalFields": {
                      "callback_data": "style_show"
                    }
                  },
                  {
                    "text": "âœï¸ Set",
                    "additionalFields": {
                      "callback_data": "style_set"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "âž• Add",
                    "additionalFields": {
                      "callback_data": "style_add"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "âœ… Done",
                    "additionalFields": {
                      "callback_data": "style_done"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "e7e29ffd-90dd-4e05-af13-452e687a46eb",
      "name": "Send Style Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        1888
      ],
      "webhookId": "a1dd9d1e-e532-4caf-8409-5a518361c76c",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "ðŸ“Œ showing style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        432,
        2320
      ],
      "id": "51631f0b-47ea-40a3-9d12-4bd0c2128395",
      "name": "Answer Callback (Style Show)",
      "webhookId": "5ddd36e4-731c-4b21-8ef1-b5070b45434e",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœï¸ set style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        464,
        2768
      ],
      "id": "ed302a97-48f0-43bb-a3b3-745b9e0c546a",
      "name": "Answer Callback (Style Set)",
      "webhookId": "f5b532dc-bb52-4fa7-a60b-a29fe5eb0528",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âž• add style"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        432,
        3200
      ],
      "id": "896ee8d9-cfe3-4d9b-8ee6-0098c5cb8a68",
      "name": "Answer Callback (Style Add)",
      "webhookId": "256c6925-fbf9-4821-9301-422743e4b7f9",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Parse Input').first().json.callback_query_id }}",
        "additionalFields": {
          "text": "âœ… Done. Cleaning up style messagesâ€¦"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        3664
      ],
      "id": "c9db147c-2abd-4f8d-bf54-1468176880ad",
      "name": "Answer Callback (Style Done)",
      "webhookId": "962f83d3-3b4d-4e40-804e-5932b635068f",
      "retryOnFail": false,
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "action": "SET",
            "scope": "user",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        656,
        2768
      ],
      "id": "4fd05254-5311-47f1-acae-77f5338273ac",
      "name": "Style Pending - Upsert (SET)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "action": "ADD",
            "scope": "user",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        656,
        3200
      ],
      "id": "bcc685c1-2000-4ae0-98a5-d88e8343d63d",
      "name": "Style Pending - Upsert (ADD)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Send your style text now. (expires in 10 minutes)",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "efb43b33-f2ff-4fff-a6ca-8ace27916b3c",
      "name": "Send Style Prompt (Set)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        864,
        2768
      ],
      "webhookId": "791d0445-bcd7-432f-a761-455a627d9f4b",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "Send extra style rules now. (expires in 10 minutes)",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "484d899c-1d17-42f3-9edd-9d57c5d89939",
      "name": "Send Style Prompt (Add)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        864,
        3200
      ],
      "webhookId": "22b4a6c3-39e2-42cb-88f1-b88973fa51db",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1728,
        3856
      ],
      "id": "b3e10245-3cf4-4246-ba26-ccaf93c02eaf",
      "name": "Style Pending - Clear (button)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Get pending_actions (check)').all().map(i => i.json || {});\nconst active = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId && Date.parse(r.expires_at||'') > Date.now());\nconst latest = pickLatest(active);\nreturn [{ json: { has_pending: !!latest, action: latest ? latest.action : '', scope: latest ? latest.scope : '' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        5280
      ],
      "id": "8f37da04-c420-44ea-81a8-0703618f69f0",
      "name": "Check Style Pending"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "scope": "={{ $json.scope }}",
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "prefs_text": "={{ $json.prefs_text }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "prefs_text",
              "displayName": "prefs_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1744,
        5280
      ],
      "id": "3e47d827-9e42-4c4f-b77b-88c3ba21ced4",
      "name": "Apply Style Pending",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "scope",
              "displayName": "scope",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1968,
        5280
      ],
      "id": "74e524cc-001b-4150-8078-2e3f7b747848",
      "name": "Style Pending - Clear (message)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Input').first().json.chat_id }}",
        "text": "saved. iâ€™ll use this for future drafts.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "d259a5cc-ec5f-445c-b3b3-498890542608",
      "name": "Send Style (Saved via pending)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2192,
        5280
      ],
      "webhookId": "17e73511-e9a4-47e3-8620-7f93146243a0",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        1888
      ],
      "id": "03a49b90-ebe4-41e8-89af-4968f121e363",
      "name": "Style Session - Init Table (Menu)"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "message_ids": "[]",
            "expires_at": "={{ new Date(Date.now() + 10*60*1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        864,
        1888
      ],
      "id": "cfb24599-90b7-49de-8d5c-e647a92f6cff",
      "name": "Style Session - Start (Menu)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1760,
        1888
      ],
      "id": "3d2f59f0-b989-4c94-9f10-258d4a63f73d",
      "name": "Style Session - Append MsgId (Bot)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1056,
        5280
      ],
      "id": "c13f6125-d4b4-447e-99f0-7e7c54af1a4b",
      "name": "Style Session - Append MsgId (User)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        3664
      ],
      "id": "4b70bbd2-fde2-4d12-9ab3-824d26014017",
      "name": "Style Session - Init Table (Done)"
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Get message_ids (done)').all().map(i => i.json || {});\nconst active = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId && Date.parse(r.expires_at||'') > Date.now());\n\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\n\nconst merged = [];\nfor (const r of active) {\n  const list = parseList(r.message_ids);\n  for (const v of list) merged.push(v);\n}\nconst ids = merged.map(toInt).filter(n => n !== null);\nconst uniq = Array.from(new Set(ids));\nreturn [{ json: { message_ids: JSON.stringify(uniq) } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        3664
      ],
      "id": "32bf5358-3649-422e-aba7-59f4a25fd5b1",
      "name": "Style Session - Get (Done)"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $('Parse Input').first().json.chat_id;\nconst raw = $json.message_ids;\nconst extra = [\n  $('Parse Input').first().json.telegram_msg_id,\n  $('Parse Input').first().json.message_id,\n];\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = [...parseList(raw), ...extra];\nconst ids = list.map(toInt).filter(n => n !== null);\nconst uniq = Array.from(new Set(ids));\nreturn uniq.map(message_id => ({ json: { chat_id: chatId, message_id } }));\n"
      },
      "id": "e755c83d-b166-49bd-bea4-3a5f323874cf",
      "name": "Split Style Session Msg IDs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        3664
      ]
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.chat_id }}",
        "messageId": "={{ $json.message_id }}"
      },
      "id": "4a3788c2-5eb5-42f2-825c-63abc5690cb6",
      "name": "Delete Style Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1440,
        3664
      ],
      "webhookId": "b6b4c49c-66ba-4740-9afe-8557be00c927",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ String($('Parse Input').first().json.chat_id || '') }}",
            "user_id": "={{ String($('Parse Input').first().json.from_id || '') }}",
            "message_ids": "[]",
            "expires_at": "={{ new Date(Date.now() - 1000).toISOString() }}",
            "updated_at": "={{ new Date().toISOString() }}",
            "row_number": 0
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1728,
        3664
      ],
      "id": "f597f1cd-b7bb-4787-b77a-496a0cdaa2b7",
      "name": "Style Session - Clear (Done)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "APPROVE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8a627fc3-5300-4e85-a7ba-ded92f5a6a0e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "APPROVE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "EDIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0b0549a4-6c59-4b16-b0de-37340dad3921"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EDIT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "HISTORY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "81a38b93-e622-4041-a61c-32d0d396956e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HISTORY"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -672,
        624
      ],
      "id": "6ba4cb27-b164-4280-b2fd-7de4fb06b990",
      "name": "Button Action (Core)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_MENU",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c2f054ee-79a6-4935-9b89-6c424bdd8b7b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE MENU"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_SHOW",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b51c50c2-06c5-40a6-949d-857d48fd1426"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE SHOW"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_SET",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "420ba027-4efd-4ccd-8d5e-507855ef0002"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE SET"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_ADD",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "85089634-04f2-4d5f-af9b-daccb0930bd3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE ADD"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "STYLE_DONE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6864225d-b1c0-4372-9855-46bcc4d4e55a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "STYLE DONE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -176,
        2192
      ],
      "id": "6d903999-406d-4084-b4ac-79f941860b13",
      "name": "Button Action (Style)"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1520,
        3200
      ],
      "id": "db84f7e1-8fae-4c9c-b0d8-1d15ea8f2896",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2880,
        5280
      ],
      "id": "9b3a0e71-0ebf-42ba-99ea-32a9695f6fbb",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || r.expires_at || r.created_at || r.createdAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst prefs = $('Get prefs (style show button)').all().map(i => i.json || {});\nconst modeRow = pickLatest(prefs.filter(r => r.scope === 'mode' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst mode = (modeRow && modeRow.prefs_text) ? String(modeRow.prefs_text) : 'user';\nconst userRow = pickLatest(prefs.filter(r => r.scope === 'user' && String(r.chat_id||'') === chatId && String(r.user_id||'') === userId));\nconst chatRow = pickLatest(prefs.filter(r => r.scope === 'chat' && String(r.chat_id||'') === chatId && String(r.user_id||'') === ''));\nreturn [{ json: { chat_id: chatId, user_id: userId, mode, user_prefs: (userRow && userRow.prefs_text) || '', chat_prefs: (chatRow && chatRow.prefs_text) || '' } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        2320
      ],
      "id": "d24b731f-8832-48e1-bc9b-462c8f492657",
      "name": "Style - Show (SQL) (Button Action (Style))"
    },
    {
      "parameters": {
        "jsCode": "const mode = String($json.mode || 'user').toLowerCase();\nconst userPrefs = String($json.user_prefs || '').trim();\n\n\nconst modeLabel = (mode === 'chat') ? 'chat' : 'me';\n\nlet out = `User style:\\n${userPrefs ? userPrefs : '(empty)'}\\n\\n`;\n\n\nreturn [{ json: { ...$json, reply_text: out } }];"
      },
      "id": "20b6326e-1c11-44a3-b0d4-57c25afc269d",
      "name": "Format Style Show (Style - Show (SQL) (Button Action (Style)))",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        2320
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.reply_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "ab1750c4-e8d6-4255-a0c8-81abfdc53b95",
      "name": "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1520,
        2320
      ],
      "webhookId": "f38d5914-c980-45af-a9cb-0bb221c823f9",
      "credentials": {
        "telegramApi": {
          "id": "NOr4RTc2yK3WqTT7",
          "name": "Action Needed"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}",
            "row_number": 0
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2192,
        2320
      ],
      "id": "01f7c117-6d7c-4667-bd9a-39b1b1160576",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style)))))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-haiku-4-5-20251001",
          "mode": "list",
          "cachedResultName": "Claude Haiku 4.5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        1888,
        4720
      ],
      "id": "be8e4917-1278-4d99-ae10-71ec41cbf3da",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "1ZrMc80LZuNYTpxa",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot8298402532:AAFCjmQZ9sQ88xArE_S16PiQtmQ1cabjWks/{{$json.result.file_path}}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3136,
        2432
      ],
      "id": "03a3503f-354d-4e7c-90d3-2a4838e3702a",
      "name": "Download Voice Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8547339878:AAHrRi1Vx0aWd547hel1VSZuS6Q3ooyQ_Y0/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.chat_id }}"
            },
            {
              "name": "message_thread_id",
              "value": "8"
            },
            {
              "name": "text",
              "value": "={{ $json.history_text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1584,
        1152
      ],
      "id": "0fdb4a8b-161e-4f23-999d-e65906496acb",
      "name": "History Topic Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8298402532:AAFCjmQZ9sQ88xArE_S16PiQtmQ1cabjWks/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Execute a SQL query1').first().json.telegram_chat_id }}"
            },
            {
              "name": "message_thread_id",
              "value": "10"
            },
            {
              "name": "text",
              "value": "=âœ… {{   'Sent email:' + ($('Execute a SQL query1').first().json.draft_subject || '') +  '\\n\\nBody:\\n' + ($('Execute a SQL query1').first().json.draft_body || '')}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1840,
        224
      ],
      "id": "28409ac4-c5ab-43e7-bcaa-99d3db3ffea4",
      "name": "Sent Email Telegram"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8526061026:AAGl8wxM1P4mh4CBLSLiZeeE9sbcfxQuyRY/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "-1003772493573"
            },
            {
              "name": "message_thread_id",
              "value": " 20"
            },
            {
              "name": "text",
              "value": "âš ï¸ Sorry â€” the email assistant hit an error and couldnâ€™t send this email to Telegram. Please contact the product seller to fix it."
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -912,
        5728
      ],
      "id": "4830eae9-9acb-4e53-9388-29aa6657cd34",
      "name": "HTTP Request - Error Notice"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1344,
        4576
      ],
      "id": "e2be0c13-30bd-4ac5-bd27-82a6404b3211",
      "name": "Get email_drafts (edit)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1536,
        4576
      ],
      "id": "45c120cc-209c-4c3e-bd53-1aed5f9762d6",
      "name": "Get prefs (edit)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        272,
        224
      ],
      "id": "fff6bc21-7568-4c60-9cf5-a04faa570ebc",
      "name": "Get email_drafts (approve)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        240,
        1152
      ],
      "id": "9186df8e-f368-44f0-bc4e-efe7930039a7",
      "name": "Get email_drafts (history)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        688,
        2320
      ],
      "id": "2e5e33c8-3e2c-45c4-bcaa-5f142a4beb19",
      "name": "Get prefs (style show button)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1953836465,
          "mode": "list",
          "cachedResultName": "pending_actions"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        208,
        5280
      ],
      "id": "96ff5876-a343-4930-a1dc-db1b0aea2d75",
      "name": "Get pending_actions (check)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        848,
        3664
      ],
      "id": "ee8723b3-8803-47f6-8c09-cae930d929ce",
      "name": "Get message_ids (done)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        688,
        4576
      ],
      "id": "79dbe511-6db8-4ad2-9716-00b22f2a9a39",
      "name": "Append User Edit MsgId (body) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Prepare Edit Data').first().json.user_message_id || '');\nconst key = String($('Prepare Edit Data').first().json.draft_id || '');\nconst rows = $('Append User Edit MsgId (body) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        4576
      ],
      "id": "a79dd515-1a29-4c8f-bde8-d262f46bb6fd",
      "name": "Append User Edit MsgId (body) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5008,
        4784
      ],
      "id": "18cfee6f-fb01-46aa-a995-93135259c3cf",
      "name": "Append Bot Draft MsgId (body) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Send Revised Draft').first().json.result.message_id || '');\nconst key = String($('Execute a SQL query').first().json.gmail_message_id || '');\nconst rows = $('Append Bot Draft MsgId (body) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5232,
        4784
      ],
      "id": "38a4d8d0-32b7-4f94-852e-27719b298c19",
      "name": "Append Bot Draft MsgId (body) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "email_drafts"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1184,
        672
      ],
      "id": "1222d699-ff6c-4ab2-b979-03b99e7a05ce",
      "name": "Append Bot MsgId (Edit Mode Started) (Get email_drafts)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const add = String($('Send Edit Mode Started Msg').first().json.result.message_id || '');\nconst key = String($('Parse Input').first().json.draft_id || '');\nconst rows = $('Append Bot MsgId (Edit Mode Started) (Get email_drafts)').all().map(i => i.json || {});\nconst match = rows.filter(r => String(r.gmail_message_id||'') === String(key));\nconst row = match.length ? match[match.length - 1] : {};\nconst cur = String(row.telegram_message_ids || '').trim();\nconst next = cur ? (cur + ',' + String(add||'')) : String(add||'');\nreturn [{ json: { gmail_message_id: String(key), telegram_message_ids: next } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        672
      ],
      "id": "2561e52c-401b-487e-8c88-98836a38a0c7",
      "name": "Append Bot MsgId (Edit Mode Started) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586452316,
          "mode": "list",
          "cachedResultName": "prefs"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1296,
        5280
      ],
      "id": "05d868cf-03e7-423d-9bd1-ab0b3aed2264",
      "name": "Get prefs (style pending)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "function pickLatest(rows) {\n  if (!rows || !rows.length) return null;\n  const withTime = rows.map(r => ({\n    r,\n    t: Date.parse(r.updated_at || r.updatedAt || '')\n  }));\n  withTime.sort((a,b) => {\n    if (isFinite(a.t) && isFinite(b.t)) return a.t - b.t;\n    if (isFinite(a.t)) return 1;\n    if (isFinite(b.t)) return -1;\n    return 0;\n  });\n  return withTime[withTime.length - 1].r;\n}\nconst chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst scope = String($('Check Style Pending').first().json.scope || 'user');\nconst action = String($('Check Style Pending').first().json.action || 'SET');\nconst newText = String($('Parse Input').first().json.text || '');\nconst prefs = $('Get prefs (style pending)').all().map(i => i.json || {});\nconst targetUser = scope === 'chat' ? '' : userId;\nlet finalText = newText;\nif (action === 'ADD') {\n  const current = pickLatest(prefs.filter(r => r.scope === scope && String(r.chat_id||'') === chatId && String(r.user_id||'') === targetUser));\n  const curText = current && current.prefs_text ? String(current.prefs_text) : '';\n  finalText = curText ? (curText + '\\n' + newText) : newText;\n}\nreturn [{ json: { scope, chat_id: chatId, user_id: targetUser, prefs_text: finalText, updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1536,
        5280
      ],
      "id": "4a346546-4d89-4114-a9eb-e5ca66b6e1bb",
      "name": "Apply Style Pending (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1312,
        1888
      ],
      "id": "ef00bad6-8847-45a8-8f8d-35a031cb3e38",
      "name": "Style Session - Append MsgId (Bot) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Send Style Menu').first().json.result?.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1536,
        1888
      ],
      "id": "2a9e53d1-3cac-4358-b405-5237c9f7d74c",
      "name": "Style Session - Append MsgId (Bot) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        624,
        5280
      ],
      "id": "2f134693-bff7-43ed-b1d9-7c02bfc697b5",
      "name": "Style Session - Append MsgId (User) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (User) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Parse Input').first().json.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        5280
      ],
      "id": "b4e988d5-44e5-40e7-aebd-6b3cc9ce58c5",
      "name": "Style Session - Append MsgId (User) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1088,
        2768
      ],
      "id": "529aeaaf-bd47-43f6-b10f-ec08952b85a9",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Send Style Prompt (Set)').first().json.result?.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        2768
      ],
      "id": "79b3c94e-ddb3-4c20-a7df-86479f9e41d5",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1088,
        3200
      ],
      "id": "8fc99c2a-104c-44b2-bb38-c7f64fd95c77",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Send Style Prompt (Add)').first().json.result?.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        3200
      ],
      "id": "5c7b123c-1bda-4334-889d-c578bef57a5a",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2416,
        5280
      ],
      "id": "e69ae7d5-499b-465c-8676-a83bfb2a6963",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Send Style (Saved via pending)').first().json.result?.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        5280
      ],
      "id": "5becf79f-a516-4a46-b426-94990e7e7d6e",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1744,
        2320
      ],
      "id": "127c6702-113b-4b76-bab3-1b1ec2ab0b12",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = String($('Parse Input').first().json.chat_id || '');\nconst userId = String($('Parse Input').first().json.from_id || '');\nconst rows = $('Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)').all().map(i => i.json || {});\nconst current = rows.filter(r => String(r.chat_id||'') === chatId && String(r.user_id||'') === userId);\nconst latest = current[current.length - 1] || {};\nconst parseList = (val) => {\n  if (!val) return [];\n  if (Array.isArray(val)) return val;\n  const s = String(val).trim();\n  if (!s) return [];\n  if (s.startsWith('[')) {\n    try {\n      const arr = JSON.parse(s);\n      if (Array.isArray(arr)) return arr;\n    } catch (e) {}\n  }\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n};\nconst toInt = (v) => {\n  const s = String(v ?? '').replace(/[^0-9]/g, '');\n  if (!s) return null;\n  const n = Number(s);\n  return Number.isInteger(n) ? n : null;\n};\nconst list = parseList(latest.message_ids).map(toInt).filter(n => n !== null);\nconst add = String($('Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))').first().json.result?.message_id || '');\nconst addId = toInt(add);\nif (addId !== null) list.push(addId);\nconst uniq = Array.from(new Set(list));\nreturn [{ json: { chat_id: chatId, user_id: userId, message_ids: JSON.stringify(uniq), expires_at: new Date(Date.now() + 10*60*1000).toISOString(), updated_at: new Date().toISOString() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1968,
        2320
      ],
      "id": "86f01161-3781-45a9-99b0-a54c163067fe",
      "name": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)"
    },
    {
      "parameters": {
        "content": "## VOICE INTAKE\n- Telegram Trigger receives messages.\n- Check if the message includes a voice file_id.\n- If yes: fetch the file and download the audio.\n- If no: skip this branch (handle text elsewhere).\n",
        "height": 384,
        "width": 848,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3856,
        2288
      ],
      "typeVersion": 1,
      "id": "ad38eec3-047d-4840-9576-ef6750fa7015",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## TRANSCRIBE AUDIO\n- Save the downloaded audio to disk.\n- Convert/prepare the audio file (command step).\n- Send audio to Deepgram for transcription.\n- Cleanup temporary voice files to save disk space.\n",
        "height": 480,
        "width": 1056,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2944,
        2160
      ],
      "typeVersion": 1,
      "id": "9ad246ad-af9d-48a8-a2bf-2f41de43f7c3",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## PARSE + ROUTE\n- Parse the transcript into a clean text input.\n- Route by type (command / request / preference / other).\nThis makes voice input behave the same as typed input.\n",
        "height": 320,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1536,
        2320
      ],
      "typeVersion": 1,
      "id": "91b0a616-ccba-4921-a47e-f10cb0287adf",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## BUTTON ACTION ROUTER\nUser clicks a Telegram button.\nWe answer the callback, then route to:\n- APPROVE: send the email\n- EDIT: start edit mode\n- HISTORY: show recent thread + session history\n",
        "height": 432,
        "width": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -736,
        400
      ],
      "typeVersion": 1,
      "id": "dab23234-d122-41c8-95ce-442d12c01243",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## APPROVE FLOW\n- Load the latest draft\n- Mark session approved/consumed\n- Confirm â€œDoneâ€ in Telegram\n- Delete old draft if needed\n- Send the reply email in Gmail\n- Notify sent status in Telegram\n",
        "height": 432,
        "width": 3264,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        0
      ],
      "typeVersion": 1,
      "id": "6956fcc3-a3ff-47e9-b865-d97fa475f119",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## EDIT FLOW\n- Create/pick the latest edit session\n- Notify user that edit mode started\n- Save Telegram bot message IDs\nThese IDs are used later for cleanup.\n",
        "height": 384,
        "width": 1808,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        496
      ],
      "typeVersion": 1,
      "id": "e9da3236-7dd5-43f3-ab97-f83454e46da9",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## HISTORY FLOW\n- Load session row + threadId\n- Fetch the thread and pick last N messages\n- Format a short history view\n- Send the history summary to Telegram\n",
        "height": 384,
        "width": 1744,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        976
      ],
      "typeVersion": 1,
      "id": "16efdb91-4d69-45e4-bb19-763f2a6ed442",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## STYLE ACTION ROUTER\nRoutes by {{$json.action}} from Telegram buttons:\n- STYLE_MENU  â†’ show style menu + start session\n- STYLE_SHOW  â†’ show current style settings\n- STYLE_SET   â†’ ask user to set/replace style prefs\n- STYLE_ADD   â†’ ask user to add extra style rules\n- STYLE_DONE  â†’ exit style mode + cleanup messages\n",
        "height": 576,
        "width": 320
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -256,
        1872
      ],
      "typeVersion": 1,
      "id": "e62c94d7-bd72-482a-bcd1-988d5053ba87",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## STYLE_MENU (START)\n- Answer Telegram callback.\n- Create/initialize style session storage.\n- Send the style menu buttons to the user.\n- Save bot message IDs (for later cleanup).\n",
        "height": 368,
        "width": 1520,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        384,
        1712
      ],
      "typeVersion": 1,
      "id": "e025df1b-4efe-4fb1-883a-d2cb5c70ed86",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## STYLE_SHOW (VIEW)\n- Load current writing/style preferences (sheet/SQL).\n- Format a readable summary.\n- Send it to Telegram.\n- Save bot message IDs.\n",
        "height": 368,
        "width": 1952,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        384,
        2144
      ],
      "typeVersion": 1,
      "id": "95962d41-96a5-4bc1-9154-4bd561efda71",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## STYLE_SET (REPLACE STYLE)\n- Answer Telegram callback.\n- Mark â€œstyle pending = SETâ€ (we are waiting for new style text).\n- Ask user to send their new writing/style preferences.\n- When user replies, we overwrite/replace the saved style rules.\n- Save bot message IDs for cleanup.\n",
        "height": 384,
        "width": 1280,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        400,
        2576
      ],
      "typeVersion": 1,
      "id": "cf0b96ae-c782-4a10-b4d1-5be3487127c3",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "## STYLE_ADD (ADD MORE RULES)\n- Answer Telegram callback.\n- Mark â€œstyle pending = ADDâ€ (we are waiting for extra rules).\n- Ask user to send additional style instructions.\n- When user replies, we append the new rules to existing preferences.\n- Save bot message IDs for cleanup.\n",
        "height": 416,
        "width": 1312,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        384,
        3024
      ],
      "typeVersion": 1,
      "id": "c7b87f4d-ef8e-4b3c-affe-c76cc4d19542",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## STYLE_DONE (CLEAN EXIT)\n- Fetch stored bot message IDs for this style session.\n- Delete those Telegram messages to keep chat clean.\n- Clear style session + clear any â€œpendingâ€ flags.\n",
        "height": 512,
        "width": 1488,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        400,
        3520
      ],
      "typeVersion": 1,
      "id": "56582003-0244-4523-8e52-7e7b73cfd4de",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## CHECK EDIT SESSION (VALIDATE EDIT MODE)\nThese 3 nodes check whether the user is currently in an active edit session for this chat_id + user_id.\n\n### Check Edit Session (Google Sheets â€“ read: sheet)\n\n* Read the `edit_sessions` sheet.\n* Pull session rows for this chat/user (used to see if mode = waiting_edit and whether itâ€™s expired).\n\n### Code in JavaScript (Code)\n\n* Filter by `chat_id` + `user_id`.\n* Pick the latest session row.\n* Compare `expires_at` with current time.\n* Output `valid: true/false` + reason (OK / EXPIRED / NO_SESSION).\n\n### Session Valid? (IF)\n\n* True path = session is valid AND mode is `waiting_edit` (continue the edit flow).\n* False path = no session or expired (stop/route to normal flow).\n",
        "height": 720,
        "width": 608
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -528,
        4048
      ],
      "typeVersion": 1,
      "id": "35f541e1-49ad-42af-b9f7-52d6dd8df201",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## DRAFT EDIT (INPUT + ROUTE)\n- Decode incoming payload (chat_id user_id message_id text).\n- Route the â€œnext stepâ€ / intent (what the user wants to do next).\n- Build a clean draft-edit context object for downstream nodes.\n",
        "height": 320,
        "width": 512,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        112,
        4432
      ],
      "typeVersion": 1,
      "id": "cf59bdae-6d8d-4e4c-bfa3-8aee4820bc8c",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "content": "## LOG + LOAD CONTEXT\n- Append user message + metadata to Sheets (history + message IDs).\n- Load latest draft state (draft_id subject body thread refs).\n- Load prefs_text (user/chat scope writing style rules).\n- Output a single context bundle for the LLM step.\n",
        "height": 368,
        "width": 1008,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        640,
        4400
      ],
      "typeVersion": 1,
      "id": "87f0086d-8276-4a08-a746-a48bf72ae9f2",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "## GENERATE EDITED DRAFT (LLM)\n- Build the final prompt (original draft + user request + prefs_text).\n- Run LLM to produce the revised email draft text.\n- Return clean output ready for Gmail draft creation.\n",
        "height": 448,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1680,
        4416
      ],
      "typeVersion": 1,
      "id": "a7b4e967-cce1-4dc4-9d35-f323d19ed51a",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## CLEANUP TEMP â€œDESIREDâ€ MESSAGE\nIf a temporary â€œdesired editâ€ message exists:\n- Split stored msg_ids into a list.\n- Delete those Telegram messages (keep chat clean).\n- Clear the stored desired-msg state so it wonâ€™t run again.\n",
        "height": 336,
        "width": 1008,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2160,
        4400
      ],
      "typeVersion": 1,
      "id": "7ef678e8-7c77-4576-a086-f2074539b260",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "## UPDATE GMAIL DRAFT + SAVE STATE\n- If an old Gmail draft exists: delete it (avoid duplicates).\n- Create a new Gmail draft with the edited text.\n- Store the new draft_id/link back to Sheets.\n- Send review/preview message to Telegram.\n- Append bot msg_ids to Sheets for later cleanup.\n- Extend the edit session so user can continue editing.\n",
        "height": 560,
        "width": 2544,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3296,
        4400
      ],
      "typeVersion": 1,
      "id": "aaf05449-e483-4a2d-bc97-de73141e0f49",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "content": "## STYLE PENDING (APPLY USER MESSAGE)\nWhen the user sends a message, we check if a pending style action is active\nfor this chat_id + user_id (not expired).\n\nFlow:\n- Read pending action from sheet (SET or ADD + scope).\n- Validate pending is still active (not expired).\n- Load current prefs_text for the same scope.\n- Build final prefs_text:\n  SET = replace with userâ€™s new text\n  ADD = append userâ€™s text to existing prefs_text\n- Save updated prefs_text back to prefs sheet (update updated_at).\n- Clear/expire the pending record so it wonâ€™t run again.\n- Send confirmation: â€œsaved. iâ€™ll use this for future drafts.â€\n- Append msg_ids (user + bot) into style session log for cleanup.\n",
        "height": 544,
        "width": 2944,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        160,
        4928
      ],
      "typeVersion": 1,
      "id": "0311aad7-20a3-4e58-b18b-e859a7b22753",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "## ERROR HANDLER\n- TRIGGER ON WORKFLOW ERROR\n- SEND ALERT TO TELEGRAM (FAILED TOPIC)\n",
        "height": 320,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1168,
        5600
      ],
      "typeVersion": 1,
      "id": "d8774a8c-079b-48c8-a6ca-5e550c540c2d",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0",
          "mode": "list",
          "cachedResultName": "n8n automation",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EB-MUC7mL69LVyrxYFvoBwZz83wqUqr29sn9_isOsd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1998009706,
          "mode": "list",
          "cachedResultName": "message_ids"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "user_id": "={{ $json.user_id }}",
            "message_ids": "={{ $json.message_ids }}",
            "expires_at": "={{ $json.expires_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "chat_id",
            "user_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_ids",
              "displayName": "message_ids",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expires_at",
              "displayName": "expires_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1520,
        2768
      ],
      "id": "d7d2ae9c-aca2-4f28-ba55-8ef66d814cc3",
      "name": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set))",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mH2aVquJ4ty4Ez8y",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Has Voice? (file_id)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Voice? (file_id)": {
      "main": [
        [
          {
            "node": "Get a file",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a file": {
      "main": [
        [
          {
            "node": "Download Voice Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk": {
      "main": [
        [
          {
            "node": "Execute a command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a command": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk1": {
      "main": [
        [
          {
            "node": "Deepgram Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deepgram Transcribe": {
      "main": [
        [
          {
            "node": "Cleanup voice files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cleanup voice files": {
      "main": [
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Input": {
      "main": [
        [
          {
            "node": "Route by Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Type": {
      "main": [
        [
          {
            "node": "Button Action (Core)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Button Action (Style)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Edit)": {
      "main": [
        [
          {
            "node": "Create Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Edit Session": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Valid?": {
      "main": [
        [
          {
            "node": "Decide Next Step",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get pending_actions (check)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Edit Data": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Edits (LLM)": {
      "main": [
        [
          {
            "node": "Has Stored Edit Msg IDs? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Revised Draft": {
      "main": [
        [
          {
            "node": "Send Edit Mode Started Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Draft in DB": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Session Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Apply Edits (LLM)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Consume Session (Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body)": {
      "main": [
        [
          {
            "node": "Get email_drafts (edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Stored Edit Msg IDs?": {
      "main": [
        [
          {
            "node": "Split Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Stored Edit Msg IDs": {
      "main": [
        [
          {
            "node": "Delete Stored User Edit Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Stored User Edit Message": {
      "main": [
        [
          {
            "node": "Collapse After Deletes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Deletes": {
      "main": [
        [
          {
            "node": "Clear Stored Edit Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body)": {
      "main": [
        [
          {
            "node": "Extend Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consume Session (Reply)": {
      "main": [
        [
          {
            "node": "Collapse After Consume (Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Consume (Reply)": {
      "main": [
        [
          {
            "node": "Send Done (Approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Email": {
      "main": [
        [
          {
            "node": "Sent Email Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Session Row (History)": {
      "main": [
        [
          {
            "node": "Get Thread (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Thread (History)": {
      "main": [
        [
          {
            "node": "Pick Last N Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format History": {
      "main": [
        [
          {
            "node": "History Topic Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Last N Msg IDs": {
      "main": [
        [
          {
            "node": "Get Message (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Message (History)": {
      "main": [
        [
          {
            "node": "Format History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decide Next Step": {
      "main": [
        [
          {
            "node": "Route Next Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Next Step": {
      "main": [
        [
          {
            "node": "Prepare Edit Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Stored Edit Msg IDs? (Edit)": {
      "main": [
        [
          {
            "node": "Split Stored Edit Msg IDs (Edit)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has Gmail Draft ID? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Stored Edit Msg IDs (Edit)": {
      "main": [
        [
          {
            "node": "Delete Stored Message (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Stored Message (Edit)": {
      "main": [
        [
          {
            "node": "Collapse After Deletes (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collapse After Deletes (Edit)": {
      "main": [
        [
          {
            "node": "Clear Stored Edit Msg IDs (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Stored Edit Msg IDs (Edit)": {
      "main": [
        [
          {
            "node": "Has Gmail Draft ID? (Edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Gmail Draft": {
      "main": [
        [
          {
            "node": "Store Gmail Draft IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Gmail Draft IDs": {
      "main": [
        [
          {
            "node": "Send Revised Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Gmail Draft": {
      "main": [
        [
          {
            "node": "Create Gmail Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Gmail Draft ID? (Edit)": {
      "main": [
        [
          {
            "node": "Delete Old Gmail Draft",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Gmail Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Gmail Draft1": {
      "main": [
        [
          {
            "node": "Reply Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "HTTP Request - Error Notice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Done (Approve)": {
      "main": [
        [
          {
            "node": "Delete Old Gmail Draft1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Edit Session": {
      "main": [
        [
          {
            "node": "Pick Latest Edit Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Latest Edit Session": {
      "main": [
        [
          {
            "node": "Send Edit Mode Started Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Approve)": {
      "main": [
        [
          {
            "node": "Get email_drafts (approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Edit Mode Started Msg": {
      "main": [
        [
          {
            "node": "Store Edit Mode MsgId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Edit Mode MsgId": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started) (Get email_drafts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Edit Mode Started Msg1": {
      "main": [
        [
          {
            "node": "Update Draft in DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Upsert (SET)": {
      "main": [
        [
          {
            "node": "Send Style Prompt (Set)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Upsert (ADD)": {
      "main": [
        [
          {
            "node": "Send Style Prompt (Add)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Style Pending": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Style Pending": {
      "main": [
        [
          {
            "node": "Style Pending - Clear (message)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Pending - Clear (message)": {
      "main": [
        [
          {
            "node": "Send Style (Saved via pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Init Table (Menu)": {
      "main": [
        [
          {
            "node": "Style Session - Start (Menu)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Start (Menu)": {
      "main": [
        [
          {
            "node": "Send Style Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Menu": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User)": {
      "main": [
        [
          {
            "node": "Get prefs (style pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Init Table (Done)": {
      "main": [
        [
          {
            "node": "Get message_ids (done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Get (Done)": {
      "main": [
        [
          {
            "node": "Split Style Session Msg IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Style Session Msg IDs": {
      "main": [
        [
          {
            "node": "Delete Style Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Style Message": {
      "main": [
        [
          {
            "node": "Style Session - Clear (Done)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Style Pending - Clear (button)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Prompt (Set)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style Prompt (Add)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style (Saved via pending)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Action (Core)": {
      "main": [
        [
          {
            "node": "Answer Callback (Approve)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Edit)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Action (Style)": {
      "main": [
        [
          {
            "node": "Answer Callback (Style Menu)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Show)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Set)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Add)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback (Style Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style - Show (SQL) (Button Action (Style))": {
      "main": [
        [
          {
            "node": "Format Style Show (Style - Show (SQL) (Button Action (Style)))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Style Show (Style - Show (SQL) (Button Action (Style)))": {
      "main": [
        [
          {
            "node": "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Apply Edits (LLM)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice Telegram": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sent Email Telegram": {
      "main": [
        [
          {
            "node": "Has Stored Edit Msg IDs?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (edit)": {
      "main": [
        [
          {
            "node": "Get prefs (edit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (edit)": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (approve)": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get email_drafts (history)": {
      "main": [
        [
          {
            "node": "Load Session Row (History)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (style show button)": {
      "main": [
        [
          {
            "node": "Style - Show (SQL) (Button Action (Style))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get pending_actions (check)": {
      "main": [
        [
          {
            "node": "Check Style Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get message_ids (done)": {
      "main": [
        [
          {
            "node": "Style Session - Get (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append User Edit MsgId (body) (Prepare)": {
      "main": [
        [
          {
            "node": "Append User Edit MsgId (body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot Draft MsgId (body) (Prepare)": {
      "main": [
        [
          {
            "node": "Append Bot Draft MsgId (body)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot MsgId (Edit Mode Started) (Get email_drafts)": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Bot MsgId (Edit Mode Started) (Prepare)": {
      "main": [
        [
          {
            "node": "Append Bot MsgId (Edit Mode Started)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get prefs (style pending)": {
      "main": [
        [
          {
            "node": "Apply Style Pending (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Style Pending (Prepare)": {
      "main": [
        [
          {
            "node": "Apply Style Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (User) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (User)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Set)) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Set))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style Prompt (Add)) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style Prompt (Add))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Saved via pending)) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Saved via pending))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Get message_ids)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style))))) (Prepare)": {
      "main": [
        [
          {
            "node": "Style Session - Append MsgId (Bot) (Send Style (Show)) (Send Style (Show) (Format Style Show (Style - Show (SQL) (Button Action (Style)))))",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (History)": {
      "main": [
        [
          {
            "node": "Get email_drafts (history)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Menu)": {
      "main": [
        [
          {
            "node": "Style Session - Init Table (Menu)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Show)": {
      "main": [
        [
          {
            "node": "Get prefs (style show button)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Set)": {
      "main": [
        [
          {
            "node": "Style Pending - Upsert (SET)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Add)": {
      "main": [
        [
          {
            "node": "Style Pending - Upsert (ADD)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (Style Done)": {
      "main": [
        [
          {
            "node": "Style Session - Init Table (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "0d5a4852-40ce-45f2-a24f-f1cf62dad6d2",
  "meta": {
    "instanceId": "c2319bcf64035e12fa4b23aa88003edd572c9ac2ee40ffdd07560e871f1375d3"
  },
  "id": "i3YwRJEcRxdxlzBu",
  "tags": []
}